<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vigilancia Materna</title>
	
	<link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00796b">
    <style>
        :root {
            --primary: #00796b; /* Verde Azulado M√©dico */
            --primary-dark: #004d40;
            --accent: #e91e63; /* Rosa para Puerperio */
            --emb-color: #673ab7; /* Morado para Embarazo */
            --alert-color: #d32f2f; /* Rojo Alertas */
            --bg-color: #f8f8f8;
            --card-bg: #ffffff;
            --text-main: #263238;
            --text-light: #546e7a;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Roboto', 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- ESTILOS DE ALERTAS (Faltaban) --- */
.alerta-card {
    background: white;
    border-left: 5px solid #d32f2f; /* Borde rojo a la izquierda */
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    animation: fadeIn 0.3s ease;
}
.alerta-card h4 {
    margin: 0 0 5px 0;
    color: #333;
}
.alerta-card small {
    color: #666;
    font-size: 0.9em;
}

        /* --- HEADER --- */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        header p {
            margin: 5px 0 0 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* --- CONTENEDOR PRINCIPAL --- */
        .container {
            flex: 1;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
        }

        /* --- SECCIONES --- */
        .section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 {
            color: var(--primary-dark);
            font-size: 1.3rem;
            border-left: 5px solid var(--primary);
            padding-left: 12px;
            margin-bottom: 20px;
        }

        /* --- DASHBOARD (MEN√ö PRINCIPAL) --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .dash-card {
            background: var(--card-bg);
            padding: 20px 10px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 130px;
            position: relative;
        }

        .dash-card:active { transform: scale(0.98); }

        .dash-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }
        .dash-title { font-weight: 600; font-size: 0.95rem; color: var(--text-main); }

        /* Colores espec√≠ficos de tarjetas */
        .card-alertas { border-bottom: 4px solid var(--alert-color); }
        .card-alertas .dash-icon { color: var(--alert-color); }

        .card-registro { border-bottom: 4px solid var(--primary); }
        .card-registro .dash-icon { color: var(--primary); }

        .card-emb { border-bottom: 4px solid var(--emb-color); }
        .card-emb .dash-icon { color: var(--emb-color); }

        .card-puerp { border-bottom: 4px solid var(--accent); }
        .card-puerp .dash-icon { color: var(--accent); }

        .card-arch { border-bottom: 4px solid #607d8b; background-color: #eceff1; }
        .card-arch .dash-icon { color: #455a64; }

        /* BADGE DE ALERTAS */
        .badge-counter {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--alert-color);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: none;
            animation: pulse 500ms infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* ================================================= */
        /* --- 2. SUB-MEN√ö DE REGISTRO (M√ÅS CL√ÅSICO) --- */
        /* ================================================= */
        .sub-nav {
            margin-top: 30px;
            text-align: center;
            max-width: 350px;
            margin-left: auto;
            margin-right: auto;
        }
        .sub-nav button {
            background-color: #ff9800; /* Naranja Energ√©tico */
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            margin: 12px 0;
            display: block;
            width: 100%;
            box-sizing: border-box;
            transition: background-color 0.3s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .sub-nav button:hover {
            background-color: #fb8c00;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* ================================================= */
        /* --- 3. BOTONES DE ACCI√ìN Y NAVEGACI√ìN --- */
        /* ================================================= */

        /* Bot√≥n de Guardar */
        .btn-guardar {
            background-color: #4CAF50; /* Verde Saludable */
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 25px;
            width: 100%;
            font-weight: 600;
            transition: background-color 0.3s, box-shadow 0.2s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-guardar:hover {
            background-color: #43a047;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* Bot√≥n de Regreso de Formulario (Volver a seleccionar tipo) */
        .btn-regreso-form {
            background-color: #7986cb; /* Azul Suave */
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            transition: background-color 0.3s;
        }
        .btn-regreso-form:hover {
            background-color: #5c6bc0;
        }

        /* Contenedor para la alineaci√≥n central de los botones en el detalle */
        .detalle-actions {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px; /* Espacio entre botones */
            align-items: center; /* Centra los botones en la pantalla de detalle */
        }

        /* Botones de detalle, ahora como bloques centrados */
        .btn-accion,
        .btn-global-regreso {
            padding: 12px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: 100%; /* Ocupa todo el ancho del contenedor 'detalle-actions' */
            max-width: 300px; /* M√°ximo ancho para que se vea bien en desktop */
            margin: 0 auto; /* Asegura el centrado en el contenedor */
            display: block;
            text-align: center;
        }

        /* Colores espec√≠ficos de los botones de Detalle */
        .btn-accion.corregir {
            background-color: #1d1402; /* Naranja/√Åmbar */
            color: white;
        }
        .btn-accion.corregir:hover {
            background-color: #ffa000;
        }
        .btn-accion.eliminar {
            background-color: #e53935; /* Rojo m√°s fuerte para eliminar permanentemente */
            color: white;
        }
        .btn-accion.eliminar:hover {
             background-color: #c62828;
             transform: translateY(-1px);
        }
        .btn-accion.archivar { /* NUEVO ESTILO DE ARCHIVAR */
            background-color: #296fa6; /* Azul */
            color: white;
        }
        .btn-accion.archivar:hover {
            background-color: #1976d2;
             transform: translateY(-1px);
        }
        .btn-detalle-regreso {
            background-color: #54609d; /* Azul suave para volver al listado */
            color: white;
        }
        .btn-detalle-regreso:hover {
            background-color: #5c6bc0;
        }
        .btn-detalle-menu {
             background-color: #158694; /* Cian para volver al men√∫ principal */
             color: white;
        }
        .btn-detalle-menu:hover {
             background-color: #0097a7;
        }

        /* Bot√≥n para a√±adir registro desde los listados (Mantiene su posici√≥n superior derecha) */
        .btn-nuevo-registro {
            background-color: #ff5722;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
            display: block;
            width: fit-content;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            float: right;
        }
        .btn-nuevo-registro:hover {
            background-color: #f4511e;
            transform: translateY(-1px);
        }

        /* Bot√≥n Global de Regreso (Usado solo en el listado-nav-top) */
        .btn-global-regreso.top-nav {
            float: left;
            color: rgb(74, 12, 10);
             background-color: #e7e435;
            margin-bottom: 20px;
            width: fit-content;
            max-width: none;
            padding: 10px 15px;
        }
        .btn-global-regreso.top-nav:hover {
            transform: translateY(-1px);
        }

        /* Contenedor de botones de navegaci√≥n dentro de listados */
        .listado-nav-top {
            overflow: auto; /* Limpia los floats (Global Regreso y Nuevo Registro) */
            margin-bottom: 10px;
        }


        /* --- 4. ESTILOS RESTANTES (Sin cambios funcionales importantes) --- */
        .form-ocultable {
            display: none !important;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .sub-section.active {
            display: block !important;
        }

        form label {
            display: block;
            margin-top: 15px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"], input[type="date"], input[type="number"], textarea { /* A√±adido textarea */
            padding: 12px;
            margin-top: 8px;
            display: block;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        /* Listado y Detalle */
        .list-container {
            display: flex;
            gap: 0;
        }

        .list-nombres {
            width: 100%;
            flex-grow: 1;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 0;
            border-right: none;
            transition: all 0.3s ease;
        }

        .detalle-card {
            width: 0;
            min-width: 0;
            padding: 0;
            flex-grow: 0;
            transition: all 0.3s ease;
        }

        .list-nombres ul {
            list-style: none;
            padding: 0;
            margin-left: 0;
        }
        .list-nombres li {
            background-color: #e3f2fd; /* Azul m√°s claro */
            margin-bottom: 8px;
            padding: 12px;
            border-left: 5px solid #00bcd4;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
            font-size: 1.1em;
            width: 100%;
            box-sizing: border-box;
        }
        /* Color especial para las archivadas */
        #lista-nombres-archivadas li {
             border-left: 5px solid #263238;
             background-color: #eeeeee;
        }

        .list-nombres li:hover {
            background-color: #bbdefb;
        }

        .consulta-activa .list-nombres {
            width: 0;
            min-width: 0;
            opacity: 0;
            overflow: hidden;
            flex-grow: 0;
        }
        .consulta-activa .detalle-card {
            flex-grow: 10;
            padding: 20px;
            width: auto;
            min-width: 400px;
        }

        .detalle-semanas {
            font-size: 1.6em;
            font-weight: bold;
            color: #4CAF50;
            margin-top: 10px;
            display: block;
        }
        .detalle-edad {
            font-size: 1.8em;
            font-weight: bold;
            color: #3f51b5;
            display: block;
            margin-top: 10px;
        }
        .detalle-fpp, .detalle-fin-puerperio {
            color: #d81b60; /* Usamos el color de header */
        }

        /* --- ESTILOS ESPEC√çFICOS PARA NOTAS --- */
        .nota-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-left: 4px solid #3f51b5;
            border-radius: 6px;
            background-color: #f9f9f9;
        }
        .nota-acciones {
            margin-top: 8px;
            text-align: right;
        }
        .nota-acciones button {
            background: none;
            border: none;
            color: #3f51b5;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .nota-acciones button:hover {
            background-color: #e8eaf6;
        }
        .nota-acciones button.delete {
             color: #e53935;
        }
        .nota-acciones button.delete:hover {
             background-color: #ffebee;
        }

/* --- ESTILOS MEJORADOS PARA FICHA Y PDF --- */
.ficha-container {
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 20px;
    /* Esto asegura que los colores de fondo salgan en el PDF */
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
}

.ficha-header {
    padding: 15px 20px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.header-emb { background: linear-gradient(135deg, #00796b, #004d40); }
.header-puerp { background: linear-gradient(135deg, #e91e63, #880e4f); }
.header-arch { background: linear-gradient(135deg, #607d8b, #455a64); }

.ficha-header h3 { margin: 0; font-size: 1.4em; color: white !important; }
.ficha-badge {
    background: rgba(255,255,255,0.2);
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.85em;
    font-weight: bold;
}

.ficha-body { padding: 20px; }

/* Secci√≥n de Datos Clave (Destacado) */
.dato-destacado-box {
    background-color: #f1f8e9;
    border-left: 5px solid #4CAF50;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
}
.dato-destacado-box.alerta {
    background-color: #ffebee;
    border-left: 5px solid #d32f2f;
}
.dato-grande { font-size: 1.8em; font-weight: bold; color: #263238; display: block; }
.dato-sub { font-size: 0.95em; color: #546e7a; }

/* Grid de datos (Usamos Flex para compatibilidad PDF) */
.datos-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
}
.dato-item {
    flex: 1 1 45%; /* Ocupa el 45% del ancho (2 columnas) */
    min-width: 200px;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
}
.dato-label {
    display: block;
    font-size: 0.8em;
    text-transform: uppercase;
    color: #78909c;
    font-weight: 600;
    margin-bottom: 2px;
}
.dato-valor {
    font-size: 1.1em;
    color: #37474f;
    font-weight: 500;
}

/* Tabla de Vacunas Simplificada */
.tabla-vacunas {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 0.9em;
}
.tabla-vacunas th { text-align: left; color: #546e7a; border-bottom: 2px solid #eee; padding: 5px; }
.tabla-vacunas td { border-bottom: 1px solid #eee; padding: 8px 5px; color: #333; }
.status-ok { color: #2e7d32; font-weight: bold; }
.status-pending { color: #c62828; font-style: italic; }

.seccion-titulo {
    color: #00796b;
    border-bottom: 2px solid #b2dfdb;
    padding-bottom: 5px;
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 1.1em;
}
        /* --- REGLAS DE RESPONSIVIDAD PARA TEL√âFONOS M√ìVILES (< 600px) --- */
        @media (max-width: 600px) {
            .container {
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
                min-height: 100vh;
            }

            header {
                padding: 15px 10px;
            }
            h1 {
                font-size: 1.5em;
            }

            .content {
                padding: 15px;
            }

            #inicio-menu button {
                padding: 15px;
                font-size: 1.2em;
                margin: 10px auto;
            }

            .list-container {
                flex-direction: column;
                gap: 20px;
            }

            .list-nombres {
                width: 100%;
                max-height: 50vh;
                flex-grow: 1;
                opacity: 1;
                min-width: auto;
                padding-right: 0;
            }

            .detalle-card {
                width: 100%;
                padding: 0;
                flex-grow: 0;
                display: none;
                min-width: auto;
            }

            .consulta-activa .list-nombres {
                width: 0;
                height: 0;
                opacity: 0;
                overflow: hidden;
                padding: 0;
                margin: 0;
                flex-grow: 0;
                display: none;
            }
            .consulta-activa .detalle-card {
                width: 100%;
                padding: 0;
                flex-grow: 1;
                min-width: auto;
                display: block;
            }

            /* Ajuste para los botones superiores en m√≥vil */
            .btn-global-regreso.top-nav, .btn-nuevo-registro {
                width: 48%;
                text-align: center;
                float: left;
                margin-right: 4%;
            }
            .btn-nuevo-registro {
                float: right;
                margin-right: 0;
            }
            /* Asegurar que los botones de detalle usen el ancho completo disponible */
             .btn-accion,
             .btn-global-regreso {
                 max-width: 100%;
             }
        }


.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
    margin-top: 20px;
}

.dash-card {
    background: var(--card-bg);
    padding: 20px 10px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 8px 12px rgba(0,0,0,0.08); /* Sombra ajustada */
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    border: 1px solid #6b6565;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 130px;
    position: relative;
}

.dash-card:active { transform: scale(0.98); }
.dash-card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.12); }

.dash-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }
.dash-title { font-weight: 600; font-size: 0.95rem; color: var(--text-main); }

/* Colores espec√≠ficos de tarjetas */
.card-alertas { border-bottom: 4px solid var(--alert-color); }
.card-alertas .dash-icon { color: var(--alert-color); }

.card-registro { border-bottom: 4px solid #00bcd4; }
.card-registro .dash-icon { color: #00bcd4; }

.card-emb { border-bottom: 4px solid var(--emb-color); }
.card-emb .dash-icon { color: var(--emb-color); }

.card-puerp { border-bottom: 4px solid var(--accent); }
.card-puerp .dash-icon { color: var(--accent); }

.card-arch { border-bottom: 4px solid #607d8b; background-color: #eceff1; }
.card-arch .dash-icon { color: #455a64; }

/* Badge (Contador) de Alertas */
.badge-counter {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: var(--alert-color);
    color: white;
    font-size: 0.97rem;
    font-weight: bold;
    padding: 12px 18px;
    border-radius: 18px;
    box-shadow: 0 5px 4px rgba(0,0,0,0.2);
    display: none; /* Se activa con JS */
}

/* Acciones de Respaldo (Botones peque√±os abajo) */
.backup-actions {
    background: white;
    padding: 15px;
    border-radius: 20px;
    display: flex;
    gap: 10px;
    justify-content: center;
    box-shadow: 0 13px 8px rgba(0,0,0,0.05);
}
.btn-backup {
    flex: 1;
    padding: 10px;
    border: 1px solid #080808;
    background: white;
    border-radius: 10px;
    font-size: 0.85rem;
    color: #081921;
    cursor: pointer;
    font-weight: 600;
}
.btn-backup:hover { background: #f5f5f5; }

 /* --- FOOTER (COPYRIGHT) --- */
        footer {
            background-color: #263238;
            color: #90a4ae;
            text-align: center;
            padding: 15px;
            font-size: 0.8rem;
            margin-top: auto; /* Empuja el footer al fondo */
        }

        /* Utilidades */
        .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .back-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-light); padding: 5px; }
        .hidden { display: none !important; }

        /* --- ANIMACI√ìN BOT√ìN DE ALERTA --- */
@keyframes latido-alerta {
    0% {
        box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7);
        transform: scale(1);
    }
    50% {
        transform: scale(1.05); /* Se agranda un poquito */
    }
    70% {
        box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); /* El halo se desvanece */
    }
    100% {
        box-shadow: 0 0 0 0 rgba(211, 47, 47, 0);
        transform: scale(1);
    }
}

.btn-alerta-blink {
    background-color: #d32f2f; /* Rojo fuerte */
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 20px; /* Bordes redondos */
    cursor: pointer;
    font-weight: bold;
    font-size: 0.9em;
    /* Aqu√≠ aplicamos la animaci√≥n infinita */
    animation: latido-alerta 1.5s infinite;
    transition: background-color 0.3s;
}

.btn-alerta-blink:hover {
    background-color: #b71c1c; /* Rojo m√°s oscuro al tocar */
    animation: none; /* Detener parpadeo al poner el dedo encima */
}

/* --- NUEVO ESTILO: PANEL DE CONTROL FUTURISTA --- */
.control-panel {
    background: #ffffff;
    border-radius: 20px;
    padding: 20px;
    margin-top: 25px;
    box-shadow: 0 10px 30px -10px rgba(0,0,0,0.15);
    border: 1px solid rgba(0,0,0,0.05);
}
.control-header {
    font-size: 0.85em; text-transform: uppercase; color: #90a4ae;
    letter-spacing: 1px; margin-bottom: 15px; text-align: center; font-weight: bold;
}
.btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

/* Botones Pro */
.btn-pro {
    border: none; border-radius: 12px; padding: 12px 10px;
    font-size: 0.95em; font-weight: 600; cursor: pointer; color: white;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s;
}
.btn-pro:active { transform: scale(0.96); }
.full-width { grid-column: span 2; }

/* Colores */
.pro-birth { background: linear-gradient(135deg, #e91e63, #c2185b); box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4); margin-bottom: 10px; font-size: 1.1em; }
.pro-pdf { background: linear-gradient(135deg, #2196F3, #1976D2); }
.pro-edit { background: linear-gradient(135deg, #00BCD4, #0097A7); }
.pro-archive { background: linear-gradient(135deg, #7E57C2, #512DA8); }
.pro-delete { background: rgb(43, 35, 35); color: #e53935; border: 2px solid #ffcdd2; }
.pro-back { grid-column: span 2; background: #f5f5f5; color: #546e7a; margin-top: 5px; }

/* --- ESTILOS PARA LA VENTANA DE CONFIRMACI√ìN DE PARTO --- */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); /* Fondo oscuro transparente */
    display: none; /* Oculto por defecto */
    justify-content: center; align-items: center; z-index: 2000;
}
.modal-content {
    background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px;
    text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    animation: fadeIn 0.2s ease-out;
}
.modal-titulo { color: #e91e63; margin-top: 0; font-size: 1.4em; }
.btn-modal-cancel { background: #cfd8dc; color: #455a64; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold;}
.btn-modal-confirm { background: #e91e63; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(233,30,99,0.3); }

/* ESTILOS DEL BANNER LLAMATIVO */
#install-banner {
    position: fixed;
    bottom: 20px;
    left: 20px;
    right: 20px;
    background: linear-gradient(135deg, #00796b, #004d40);
    color: white;
    padding: 16px;
    border-radius: 12px;
    display: none; /* Se oculta por defecto */
    z-index: 99999;
    box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    flex-direction: column;
    align-items: center;
    text-align: center;
    border: 2px solid rgba(255,255,255,0.2);
    animation: fadeIn 0.5s ease-out;
}
#install-banner button {
    background: #e91e63;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 25px;
    font-weight: bold;
    margin-top: 10px;
    cursor: pointer;
    width: 100%;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

    </style>
</head>
<body>

<header>
    <h1>üë©‚Äç‚öïÔ∏è Vigilancia Materna</h1>
    <p>Salud Comunitaria Coatepeque</p>

    <div id="barra-usuario" style="background-color: #263238; color: #cfd8dc; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #455a64; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <div onclick="cambiarNombreUsuario()" style="cursor: pointer; font-size: 0.9em; flex-grow: 1; text-align: center;">
            üë§ Usuario: <strong id="display-nombre-recurso" style="color: #4db6ac; text-transform: uppercase;">USUARIO</strong>
            <span style="font-size: 0.8em; opacity: 0.7; margin-left: 10px;">(Toca para cambiar)</span>
        </div>
        <button onclick="abrirConfiguracionNueva()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer; padding: 0 10px;">‚öôÔ∏è</button>
    </div>
</header>

<div class="container">

    <!-- SECCI√ìN: INICIO (DASHBOARD) -->
    <div id="inicio" class="section active">

        <!-- Grid de Tarjetas -->
        <div class="dashboard-grid">
            <!-- Alertas -->
            <div class="dash-card card-alertas" onclick="mostrarSeccion('panel-alertas')">
                <span id="contador-alertas" class="badge-counter" style="display:block;">0</span>
                <span class="dash-icon">üîî</span>
                <span class="dash-title">Alertas</span>
            </div>

            <!-- Registrar -->
            <div class="dash-card card-registro" onclick="mostrarSeccion('registro')">
                <span class="dash-icon">‚ûï</span>
                <span class="dash-title">Registrar</span>
            </div>

            <!-- Embarazadas -->
            <div class="dash-card card-emb" onclick="mostrarSeccion('listado-embarazadas')">
                <span class="dash-icon">ü§∞</span>
                <span class="dash-title">Embarazadas</span>
            </div>

            <!-- Pu√©rperas -->
            <div class="dash-card card-puerp" onclick="mostrarSeccion('listado-puerperas')">
                <span class="dash-icon">ü§±</span>
                <span class="dash-title">Pu√©rperas</span>
            </div>

            <!-- Archivadas -->
            <div class="dash-card card-arch" onclick="mostrarSeccion('listado-archivadas')">
                <span class="dash-icon">üì¶</span>
                <span class="dash-title">Archivadas</span>
            </div>
            <div class="dash-card card-reporte" onclick="generarReporteHTML()" style="border-bottom: 4px solid #00897b;">
                <span class="dash-icon">üìä</span>
                <span class="dash-title">Reporte General</span>
            </div>
            <div class="dash-card" onclick="abrirLoginSupervisor()" style="border-bottom: 4px solid #333;">
                <span class="dash-icon">üîí</span>
                <span class="dash-title">Acceso</span>
            </div>
<div class="dash-card" onclick="window.location.href='calculadora.html'" style="border-bottom: 4px solid var(--emb-color);">
    <span class="dash-icon">üßÆ</span>
    <span class="dash-title">Calculadora Obst√©trica</span>
</div>

        </div>

        <!-- Acciones de Respaldo -->
        <div class="backup-actions">
            <button class="btn-backup" onclick="exportarDatos()">üíæ Guardar Copia</button>
            <button class="btn-backup" onclick="document.getElementById('file-input-backup').click()">üì• Restaurar</button>
            <input type="file" id="file-input-backup" accept=".json" style="display: none;" onchange="importarDatos(event)">
        </div>
        <div style="margin: 20px; padding: 15px; background: #fff; border: 1px solid #ccc; border-radius: 8px; text-align: center;">
            <h4 style="margin-top:0;">Base de Datos Online</h4>
            <button id="btn-nube-guardar" onclick="guardarEnNube()" style="background: #4CAF50; color: white; padding: 10px; border: none; border-radius: 5px; margin: 5px; width: 45%;">
                ‚òÅÔ∏è Guardar en Nube
            </button>
            <button id="btn-nube-cargar" onclick="cargarDeNube()" style="background: #2196F3; color: white; padding: 10px; border: none; border-radius: 5px; margin: 5px; width: 45%;">
                üì• Bajar de Nube
            </button>
        </div>
        
    </div>



    <div id="panel-alertas" class="section">
        <div class="listado-nav-top">
            <button class="btn-global-regreso top-nav" onclick="mostrarSeccion('inicio')">‚Üê Volver al Men√∫</button>
        </div>
        <h2 style="color: #d32f2f; border-color: #d32f2f;">‚ö†Ô∏è Alertas del D√≠a</h2>

        <div id="contenedor-alertas" style="padding: 10px;">
        </div>
    </div>


    <div id="registro" class="section">
        <button class="btn-global-regreso top-nav" onclick="mostrarSeccion('inicio')">‚Üê Volver al Men√∫ Principal</button>
        <h2>‚ûï Registrar Nueva Paciente</h2>

        <div class="sub-nav" id="menu-registro-tipo">
            <button id="btn-reg-emb" onclick="mostrarRegistroSub('form-embarazada')">Registrar Embarazada</button>
            <button id="btn-reg-puerp" onclick="mostrarRegistroSub('form-puerpera')">Registrar Pu√©rpera</button>
        </div>

        <div id="form-embarazada" class="sub-section form-ocultable">
            <form id="registro-form-embarazada">
                <label for="nombre-emb">Nombre de la Paciente:</label>
                <input type="text" id="nombre-emb" required placeholder="Ej: Juana P√©rez">
                <label for="fn-emb">Fecha de Nacimiento (FN) (Opcional):</label>
                <input type="date" id="fn-emb">
                <label for="dir-emb">Direcci√≥n / Comunidad:</label>
                <input type="text" id="dir-emb" placeholder="Ej: Caser√≠o Los Pinos">

                <label style="margin-top: 25px; font-weight: 600; color: #555;">Fuente de C√°lculo (Requerido):</label>
                <div style="display: flex; gap: 20px; margin-top: 10px; margin-bottom: 10px;">
                    <label><input type="radio" name="metodo_calc" value="FUR" checked onchange="toggleFurFusFields('FUR')"> Fecha √öltima Regla (FUR)</label>
                    <label><input type="radio" name="metodo_calc" value="FUS" onchange="toggleFurFusFields('FUS')"> Ultrasonido (FUS)</label>
                </div>

                <div id="fields-fur">
                    <label for="fur">Fecha de √öltima Regla (FUR):</label>
                    <input type="date" id="fur" required>
                </div>

                <div id="fields-fus" style="display: none;">
                    <label for="fus_date">Fecha de Ultrasonido (FUS):</label>
                    <input type="date" id="fus_date">
                    <label for="egus_weeks">Semanas de Gestaci√≥n por US:</label>
                    <input type="number" id="egus_weeks" min="1" max="45" value="12">
                    <label for="egus_days">D√≠as de Gestaci√≥n por US (0-6):</label>
                    <input type="number" id="egus_days" min="0" max="6" value="0">
                </div>

                <hr>

                <h3>üíâ Vacunas (Fecha de Aplicaci√≥n)</h3>
                <label for="vacuna-influenza">Influenza:</label>
                <input type="date" id="vacuna-influenza">

                <label for="vacuna-dtpa">DTPa:</label>
                <input type="date" id="vacuna-dtpa">

                <label for="vacuna-dtadulto">DT Adulto:</label>
                <input type="date" id="vacuna-dtadulto">

                <label for="vacuna-vrs">VRS:</label>
                <input type="date" id="vacuna-vrs">
                <button type="submit" class="btn-guardar">Guardar Embarazada</button>
                <button type="button" onclick="regresarAMenuRegistro()" class="btn-regreso-form">‚Üê Volver a Seleccionar Tipo</button>
            </form>
        </div>

        <div id="form-puerpera" class="sub-section form-ocultable">
            <form id="registro-form-puerpera">
                <label for="nombre-puerp">Nombre de la Paciente:</label>
                <input type="text" id="nombre-puerp" required placeholder="Ej: Ana G√≥mez">
                <label for="fn-puerp">Fecha de Nacimiento (FN) (Opcional):</label>
                <input type="date" id="fn-puerp">
                <label for="dir-puerp">Direcci√≥n / Comunidad:</label>
                <input type="text" id="dir-puerp" placeholder="Ej: Cant√≥n El Carmen">
                <label for="fp">Fecha de Parto/Aborto (FP):</label>
                <input type="date" id="fp" required>
                <button type="submit" class="btn-guardar">Guardar Pu√©rpera</button>
                <button type="button" onclick="regresarAMenuRegistro()" class="btn-regreso-form">‚Üê Volver a Seleccionar Tipo</button>
            </form>
        </div>
    </div>

    <div id="listado-embarazadas" class="section">

        <div class="listado-nav-top">
            <button class="btn-global-regreso top-nav" onclick="mostrarSeccion('inicio')">‚Üê Men√∫ Principal</button>
            <button class="btn-nuevo-registro" onclick="iniciarRegistroDirecto('embarazada')">‚ûï Nuevo Registro</button>
        </div>

        <h2>ü§∞ Listado de Embarazadas</h2>
        <div class="list-container" id="list-container-emb">
            <div class="list-nombres">
                <input type="text" class="buscador-input" onkeyup="filtrarNombres(this)" placeholder="üîç Buscar embarazada..." style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #673ab7; margin-bottom: 10px; outline: none;">

                <ul id="lista-nombres-embarazadas"></ul>
            </div>
            <div id="detalle-embarazada" class="detalle-card">
            </div>
        </div>
    </div>

    <div id="listado-puerperas" class="section">

        <div class="listado-nav-top">
            <button class="btn-global-regreso top-nav" onclick="mostrarSeccion('inicio')">‚Üê Men√∫ Principal</button>
            <button class="btn-nuevo-registro" onclick="iniciarRegistroDirecto('puerpera')">‚ûï Nuevo Registro</button>
        </div>

        <h2>ü§± Listado de Pu√©rperas</h2>
        <div class="list-container" id="list-container-puerp">
            <div class="list-nombres">
                <input type="text" class="buscador-input" onkeyup="filtrarNombres(this)" placeholder="üîç Buscar pu√©rpera..." style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #e91e63; margin-bottom: 10px; outline: none;">

                <ul id="lista-nombres-puerperas"></ul>
            </div>
            <div id="detalle-puerpera" class="detalle-card">
            </div>
        </div>
    </div>

    <div id="listado-archivadas" class="section">

        <div class="listado-nav-top">
            <button class="btn-global-regreso top-nav" onclick="mostrarSeccion('inicio')">‚Üê Men√∫ Principal</button>
        </div>

        <h2>üì¶ Listado de Pacientes Archivadas</h2>
        <div style="background: #e1f5fe; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #b3e5fc;">
    <p style="margin: 0 0 10px 0; font-weight: bold; color: #01579b;">üîç Filtrar Archivo por Fecha:</p>
    <div style="display: flex; gap: 10px;">
        <select id="filtro-mes-arch" onchange="renderizarListadoArchivadas()" style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #81d4fa;">
            <option value="todos">Todos los Meses</option>
            <option value="01">Enero</option>
            <option value="02">Febrero</option>
            <option value="03">Marzo</option>
            <option value="04">Abril</option>
            <option value="05">Mayo</option>
            <option value="06">Junio</option>
            <option value="07">Julio</option>
            <option value="08">Agosto</option>
            <option value="09">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
        </select>
        <select id="filtro-anio-arch" onchange="renderizarListadoArchivadas()" style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #81d4fa;">
            <option value="todos">Todos los A√±os</option>
        </select>
    </div>
</div>

        <div class="list-container" id="list-container-arch">
            <div class="list-nombres">
                <input type="text" class="buscador-input" onkeyup="filtrarNombres(this)" placeholder="üîç Buscar en el archivo..." style="width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #607d8b; margin-bottom: 10px; outline: none;">

                <ul id="lista-nombres-archivadas"></ul>
            </div>
            <div id="detalle-archivada" class="detalle-card">
            </div>
        </div>
    </div>
</div>


<div id="modal-parto" class="modal-overlay">
    <div class="modal-content">
        <h3 class="modal-titulo">üèÅ Finalizar Embarazo</h3>
        
        <p style="margin-bottom: 15px; color: #555;">
            Seleccione el motivo para:<br>
            <strong id="nombre-paciente-parto" style="font-size: 1.2em; color: #00796b;"></strong>
        </p>
        
        <p id="texto-instruccion-dinamico" style="font-size: 0.9em; margin-bottom: 15px;">Seleccione una opci√≥n:</p>

        <div id="selector-tipo-final" style="display: grid; gap: 10px; margin-bottom: 20px;">
            <button onclick="seleccionarMotivo('parto')" style="background: #4caf50; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1.1em; cursor: pointer;">üë∂ ES PARTO</button>
            <button onclick="seleccionarMotivo('aborto')" style="background: #ff9800; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1.1em; cursor: pointer;">üè• ES ABORTO</button>
        </div>

        <div id="confirmacion-fecha" style="display: none;">
            <input type="date" id="fecha-parto-calendario" style="font-size: 1.2em; margin-bottom: 20px; width: 100%; padding: 10px;">
            <button class="btn-modal-confirm" onclick="confirmarParto()" style="width: 100%; margin-bottom: 10px; padding: 15px;">‚úÖ Finalizar Registro</button>
        </div>

        <button class="btn-modal-cancel" onclick="cancelarParto()" style="width: 100%; padding: 12px; background: #90a4ae;">‚ùå Cancelar / Volver</button>
    </div>
</div>



<div id="modal-login-supervisor" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:20000; justify-content:center; align-items:center; backdrop-filter: blur(4px);">
    <div style="background:white; padding:25px; border-radius:15px; text-align:center; width:90%; max-width:320px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); border: 1px solid #444;">
        
        <div style="font-size: 3rem; margin-bottom: 10px;">üëÆ‚Äç‚ôÇÔ∏è</div>
        <h2 style="color:#333; margin:0 0 15px 0; font-size: 1.5rem;">Acceso Supervisor</h2>
        
        <p style="color:#666; font-size:0.9rem; margin-bottom: 15px;">Ingresa la contrase√±a de administrador:</p>

        <input type="password" id="input-pass-supervisor" placeholder="Contrase√±a" 
               style="width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:1.1rem; text-align:center; margin-bottom:20px; outline:none;">
        
        <div style="display: flex; gap: 10px; justify-content: space-between;">
            <button onclick="cerrarLoginSupervisor()" 
                    style="flex:1; padding:12px; border:none; background:#cfd8dc; color:#455a64; border-radius:8px; cursor:pointer; font-weight:bold; font-size:0.9rem;">
                CANCELAR
            </button>
            <button onclick="verificarSupervisor()" 
                    style="flex:1; padding:12px; border:none; background:#263238; color:white; border-radius:8px; cursor:pointer; font-weight:bold; font-size:0.9rem; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
                ENTRAR
            </button>
        </div>
    </div>
</div>


<div id="panel-supervisor" class="section">
    <div class="nav-header" style="background:#333; color:white; padding:15px;">
        <h2 style="color:white; margin:0;">üëÆ‚Äç‚ôÇÔ∏è Panel Supervisor</h2>
        <button onclick="salirSupervisor()" style="background:red; color:white; border:none; padding:5px 10px; border-radius:5px;">Salir</button>
    </div>
    <div style="padding:15px;">
        <div class="dash-card">
            <h3>üìä Resumen Global</h3>
            <button id="btn-sup-cargar" onclick="cargarDeNube(true)" style="background:#ff9800; color:white; width:100%; padding:10px; border:none; border-radius:8px; font-weight:bold; margin-bottom:10px; cursor:pointer;">
                üì• DESCARGAR TODO (GLOBAL)
            </button>
            <p>Embarazadas: <b id="sup-total-emb">0</b> | Pu√©rperas: <b id="sup-total-pue">0</b></p>
            <button onclick="generarReporteGlobal()" class="btn-guardar" style="background:#00796b;">üì• Descargar Excel (CSV)</button>
        </div>

        <h3>üë• Ver datos de:</h3>
        <div id="lista-recursos-supervisor"></div>
    </div>
</div>

<div id="barra-aviso-supervisor" style="display:none; position:fixed; bottom:0; left:0; width:100%; background:#d32f2f; color:white; text-align:center; padding:15px; z-index:10000; font-weight:bold;">
    üëÅÔ∏è VISTA DE SUPERVISOR (SOLO LECTURA)
    <button onclick="regresarAlPanelSupervisor()" style="margin-left:15px; background:white; color:#d32f2f; border:none; padding:5px 15px; border-radius:15px; cursor:pointer;">SALIR DE VISTA</button>
</div>

<section id="seccion-reporte-interno" class="section">
    <div class="header-registro">
        <button class="btn-back" onclick="mostrarSeccion('inicio')">‚¨Ö Volver</button>
        <h2>Reporte Detallado General</h2>
    </div>

    <div class="card" style="overflow-x: auto;">
        <table id="tabla-reporte" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
            <thead>
            <tr style="background-color: var(--primary); color: white;">
                <th style="padding: 8px; border: 1px solid #ddd;">Tipo</th>
                <th style="padding: 8px; border: 1px solid #ddd;">Nombre</th>
                <th style="padding: 8px; border: 1px solid #ddd;">Direcci√≥n</th>
                <th style="padding: 8px; border: 1px solid #ddd;">FUR/Parto</th>
                <th style="padding: 8px; border: 1px solid #ddd;">FPP</th>
                <th style="padding: 8px; border: 1px solid #ddd;">Recurso</th>
            </tr>
            </thead>
            <tbody id="cuerpo-reporte">
            </tbody>
        </table>
    </div>
</section>

<div id="modalConfig" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; align-items:center; justify-content:center; backdrop-filter: blur(4px);">
    <div style="background:white; width:90%; max-width:380px; border-radius:15px; padding:25px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); animation: fadeIn 0.3s ease;">
        <h2 style="margin-top:0; color:var(--primary-dark); text-align:center; border:none; padding:0;">Configuraci√≥n de Sistema</h2>
        
        <p style="text-align:center; color:#666; font-size:0.9rem; margin-bottom:20px;">Gesti√≥n de mantenimiento y reinicio.</p>

        <div style="padding:15px; border:2px dashed var(--alert-color); border-radius:12px; background:#fff9f9; text-align:center;">
            <p style="color:var(--alert-color); font-weight:bold; margin:0 0 12px 0; font-size:1rem;">‚ò¢Ô∏è ZONA DE PELIGRO</p>
            
            <button onclick="refrescarApp()" style="width:100%; background:var(--alert-color); color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer; margin-bottom:12px; display:flex; align-items:center; justify-content:center; gap:8px;">
                üîÑ REFRESCAR APLICACI√ìN
            </button>
            
            <button onclick="borrarTodoDeFabrica()" style="width:100%; background:#333; color:white; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer; font-size:0.8rem; opacity:0.9;">
                ‚ö†Ô∏è BORRAR TODO Y REINICIAR
            </button>

            <p style="font-size:0.7rem; color:#777; margin-top:10px;">Use estas opciones solo si la aplicaci√≥n presenta errores de carga.</p>
        </div>

        <button onclick="cerrarConfiguracionNueva()" style="width:100%; margin-top:20px; background:#eee; border:none; padding:12px; border-radius:10px; color:#555; font-weight:bold; cursor:pointer;">CERRAR VENTANA</button>
    </div>
</div>



<!-- FOOTER CON COPYRIGHT -->
<footer>
    ¬© Mois√©s Abimael Labor - Vigilancia Materna v2.0
</footer>

<div id="install-banner">
    <span style="font-size: 1.3em; font-weight: bold;">üì≤ Instalar App de Vigilancia</span>
    <p style="margin: 5px 0; font-size: 0.9em; opacity: 0.9;">Usa la aplicaci√≥n en pantalla completa y sin internet.</p>
    <button id="btn-install">INSTALAR AHORA</button>
    <button onclick="document.getElementById('install-banner').style.display='none'" style="background:none; box-shadow:none; font-size:0.7em; margin-top:5px; text-decoration:underline;">M√°s tarde</button>
</div>

<script>
    // 1. Registro del Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js');
        });
    }

    // 2. Control del Banner de Instalaci√≥n
    let deferredPrompt;
    const installBanner = document.getElementById('install-banner');
    const btnInstall = document.getElementById('btn-install');

    window.addEventListener('beforeinstallprompt', (e) => {
        // Evita que el navegador muestre su propio aviso
        e.preventDefault();
        // Guarda el evento para usarlo luego
        deferredPrompt = e;
        // Muestra nuestro banner llamativo
        installBanner.style.display = 'flex';
    });

    btnInstall.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                console.log('El usuario instal√≥ la app');
            }
            installBanner.style.display = 'none';
            deferredPrompt = null;
        }
    });

    // Ocultar si ya est√° instalada
    window.addEventListener('appinstalled', () => {
        installBanner.style.display = 'none';
    });
</script>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<script>
  // Tu configuraci√≥n de Firebase proporcionada
  const firebaseConfig = {
    apiKey: "AIzaSyD91mG4x4Av8SEESi8HR0F0-1U5ujXP5hg",
    authDomain: "vigilancia-materna-2.firebaseapp.com",
    projectId: "vigilancia-materna-2",
    storageBucket: "vigilancia-materna-2.firebasestorage.app",
    messagingSenderId: "777102606090",
    appId: "1:777102606090:web:4578a705c28cd0d45304f3",
    measurementId: "G-ERZ72YE3JZ"
  };

  // Inicializar Firebase
  if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
  }
  const database = firebase.database();
</script>


<script src="html2pdf.bundle.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.mini.min.js"></script>

<script>
    let BLOQUEO_SUBIDA_GLOBAL = false; // Nueva variable de seguridad

const PIN_SEGURIDAD = "1234"; // Tu PIN de 4 d√≠gitos
let nubeDesbloqueada = false; // Estado inicial

    // --- VARIABLES DE DATOS ---
    let embarazadas = JSON.parse(localStorage.getItem('embarazadas')) || [];
    let puerperas = JSON.parse(localStorage.getItem('puerperas')) || [];
    // NUEVA LISTA DE PACIENTES ARCHIVADAS
    let archivadas = JSON.parse(localStorage.getItem('archivadas')) || [];
	// 1. IDENTIFICACI√ìN DE USUARIO (RECURSO)
    if(!localStorage.getItem('MI_NOMBRE_RECURSO')) {
        let nombre = prompt("Configuraci√≥n Inicial:\nEscribe TU nombre para firmar tus registros:");
        if(nombre) localStorage.setItem('MI_NOMBRE_RECURSO', nombre.toUpperCase().trim());
        else localStorage.setItem('MI_NOMBRE_RECURSO', "SIN_NOMBRE");
    }
    let MI_USUARIO = localStorage.getItem('MI_NOMBRE_RECURSO');

    // Variables del Supervisor
    let MODO_SUPERVISOR = false;
    let FILTRO_USUARIO_ACTUAL = null;

    const detalleEmbDiv = document.getElementById('detalle-embarazada');
    const detallePuerpDiv = document.getElementById('detalle-puerpera');
    const detalleArchDiv = document.getElementById('detalle-archivada'); // Nuevo
    const menuRegistroTipo = document.getElementById('menu-registro-tipo');
    const listContainerEmb = document.getElementById('list-container-emb');
    const listContainerPuerp = document.getElementById('list-container-puerp');
    const listContainerArch = document.getElementById('list-container-arch'); // Nuevo

    // --- FUNCIONES DE UTILIDAD Y C√ÅLCULO ---

    function getHoyLocal() {
        const now = new Date();
        return new Date(now.getFullYear(), now.getMonth(), now.getDate());
    }

// Funci√≥n para obtener la fecha de HOY en formato YYYY-MM-DD respetando tu zona horaria
function obtenerFechaLocalISO() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

    function crearFechaLocal(dateString) {
        const parts = dateString.split('-');
        // Asume formato 'YYYY-MM-DD'
        return new Date(parts[0], parts[1] - 1, parts[2]);
    }

    function calcularEdad(fechaNacimientoDate) {
        const hoy = new Date();
        let edad = hoy.getFullYear() - fechaNacimientoDate.getFullYear();
        const mes = hoy.getMonth() - fechaNacimientoDate.getMonth();

        if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimientoDate.getDate())) {
            edad--;
        }
        return edad;
    }

    function calcularFPP(furDate) {
        const fpp = new Date(furDate);
        fpp.setDate(fpp.getDate() + 280);
        return fpp;
    }

    function calcularFinPuerperio(fpDate) {
        const finPuerperio = new Date(fpDate);
        finPuerperio.setDate(finPuerperio.getDate() + 42);
        return finPuerperio;
    }

    function calcularEdadGestacional(furDate) {
        const hoy = getHoyLocal();
        const diasTranscurridos = Math.floor((hoy.getTime() - furDate.getTime()) / (1000 * 60 * 60 * 24));

        if (diasTranscurridos < 0) return { semanas: 0, dias: 0, diasRestantes: 280, diasTranscurridos: 0 };

        const semanas = Math.floor(diasTranscurridos / 7);
        const dias = diasTranscurridos % 7;
        const diasRestantes = 280 - diasTranscurridos;

        return { semanas, dias, diasRestantes, diasTranscurridos };
    }

        // --- NUEVA FUNCI√ìN: Calcular semanas exactas al momento del parto ---
    function calcularEdadGestacionalAlParto(furDate, fpDate) {
        // Diferencia en milisegundos
        const diffTime = fpDate.getTime() - furDate.getTime();
        // Convertir a d√≠as
        const diasTotales = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (diasTotales < 0) return "Error en fechas";

        const semanas = Math.floor(diasTotales / 7);
        const dias = diasTotales % 7;

        return `${semanas} Semanas + ${dias} d√≠as`;
    }


    function calcularPuerperio(fpDate) {
        const hoy = getHoyLocal();
        const diasPuerperio = Math.floor((hoy.getTime() - fpDate.getTime()) / (1000 * 60 * 60 * 24));

        const finPuerperioDate = calcularFinPuerperio(fpDate);
        const diasRestantes = 42 - diasPuerperio;

        return { diasPuerperio, diasRestantes, finPuerperioDate };
    }

    function calcularFechaSeguimiento(fpDate, dias) {
        const fecha = new Date(fpDate);
        fecha.setDate(fecha.getDate() + dias);
        return fecha;
    }

    function calcularFechasSeguimientoPuerpera(fpDate) {
        return {
            '24 horas': calcularFechaSeguimiento(fpDate, 1),
            '3 d√≠as': calcularFechaSeguimiento(fpDate, 3),
            '7 d√≠as': calcularFechaSeguimiento(fpDate, 7),
            '15 d√≠as': calcularFechaSeguimiento(fpDate, 15),
            '28 d√≠as': calcularFechaSeguimiento(fpDate, 28)
        };
    }

    function formatDate(date) {
        const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
        return new Intl.DateTimeFormat('es-ES', options).format(date);
    }

    // FUNCI√ìN DE GUARDADO MODIFICADA PARA ARCHIVADAS
    function guardarDatos(tipo) {
         if (tipo === 'embarazadas') {
            localStorage.setItem(tipo, JSON.stringify(embarazadas));
        } else if (tipo === 'puerperas') {
            localStorage.setItem(tipo, JSON.stringify(puerperas));
        } else if (tipo === 'archivadas') {
            localStorage.setItem(tipo, JSON.stringify(archivadas));
        }
    }

   // --- JAVASCRIPT ---

function exportarDatos() {
    // 1. Recopilar datos globales
    const data = {
        fecha_backup: new Date().toISOString(),
        embarazadas: typeof embarazadas !== 'undefined' ? embarazadas : [],
        puerperas: typeof puerperas !== 'undefined' ? puerperas : [],
        archivadas: typeof archivadas !== 'undefined' ? archivadas : []
    };

    const dataStr = JSON.stringify(data, null, 4);

    // 2. Detectar entorno
    if (typeof Android !== "undefined" && Android.guardarBackup) {
        // Opci√≥n A: Estamos en la App M√≥vil
        Android.guardarBackup(dataStr);
    } else {
        // Opci√≥n B: Estamos en PC / Navegador Web -> Forzar descarga
        descargarEnPC(dataStr, "backup_materno.json");
    }
}

// Funci√≥n auxiliar para descargar en PC
function descargarEnPC(content, fileName) {
    const a = document.createElement("a");
    const file = new Blob([content], { type: "application/json" });
    a.href = URL.createObjectURL(file);
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(a.href);
}

function importarDatos(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (!data.embarazadas || !data.puerperas) {
                alert('üö´ Formato de archivo no v√°lido.');
                return;
            }

            if (confirm(`‚ö†Ô∏è ¬øDeseas importar estos registros y firmarlos como "${MI_USUARIO}"?`)) {
                
                // Funci√≥n interna para poner tu firma a los datos viejos
                const firmarDatos = (lista) => {
                    return lista.map(p => {
                        p.registrado_por = MI_USUARIO; // <--- AQU√ç SE CORRIGE EL "DESCONOCIDO"
                        if (!p.id) p.id = Date.now().toString() + Math.random().toString(16).slice(2);
                        if (!p.direccion) p.direccion = "No especificada";
                        return p;
                    });
                };

                embarazadas = firmarDatos(data.embarazadas);
                puerperas = firmarDatos(data.puerperas);
                archivadas = firmarDatos(data.archivadas || []);

                guardarDatos('embarazadas');
                guardarDatos('puerperas');
                guardarDatos('archivadas');

                alert('‚úÖ Datos importados y firmados con tu nombre con √©xito.');
                mostrarSeccion('inicio');
            }
        } catch (error) {
            alert('üö´ Error al leer el archivo.');
        }
    };
    reader.readAsText(file);
}

    // --- FUNCION MEJORADA: RESPETA AUTOR√çA Y ASEGURA FORMATO ---
function descargarPDF(index, tipo) {
    const data = getPacientePorIndex(index, tipo);
    const paciente = data.paciente;

    // Identificar el elemento a imprimir
    let elementId = '';
    if (tipo === 'embarazada') elementId = `vista-info-emb-${index}`;
    else if (tipo === 'puerpera') elementId = `vista-info-puerp-${index}`;
    else if (tipo === 'archivada') elementId = `vista-info-arch-${index}`;

    const element = document.getElementById(elementId);
    if (!element) { alert("Error: No se encuentra la vista."); return; }

    // --- MEJORA: BUSCAR AL AUTOR ORIGINAL DEL REGISTRO ---
    // Usamos el campo 'registrado_por' guardado en la ficha. 
    // Si no existe (registros muy antiguos), ponemos un texto gen√©rico.
    const autorOriginal = paciente.registrado_por || "PERSONAL DE SALUD";

    const nombreArchivo = `Ficha_${tipo}_${paciente.nombre.replace(/ /g, '_')}.pdf`;
    
    // Configuraci√≥n optimizada para evitar saltos de l√≠nea bruscos
    const opt = {
        margin:       [0.5, 0.5, 0.5, 0.5],
        filename:     nombreArchivo,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { 
            scale: 2, 
            useCORS: true, 
            scrollY: 0,
            letterRendering: true 
        },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' },
        pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
    };

    // 2. Clonar y limpiar
    const clone = element.cloneNode(true);
    const elementosNoDeseados = clone.querySelectorAll('button, .detalle-actions, form, textarea');
    elementosNoDeseados.forEach(el => el.remove());

    // Expandir listas de notas para que salgan todas
    const listasNotas = clone.querySelectorAll('ul');
    listasNotas.forEach(lista => {
        lista.style.maxHeight = 'none';
        lista.style.overflow = 'visible';
    });

    // --- HEADER MEJORADO CON AUTOR√çA REAL ---
    const header = document.createElement('div');
    header.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #00796b; padding-bottom: 10px; font-family: sans-serif;">
            <h2 style="color:#00796b; margin: 0; font-size: 1.6rem;">Ficha Cl√≠nica - Vigilancia Materna</h2>
            <p style="color:#555; margin: 5px 0 0 0; font-size: 1rem;">Salud Comunitaria Coatepeque</p>
            <div style="margin-top: 10px; padding: 10px; background-color: #f5f5f5; border-radius: 5px;">
                <p style="margin: 0; font-size: 0.95rem; color: #333;">
                    <b>REGISTRO ORIGINAL POR:</b> <span style="color: #00796b; text-transform: uppercase;">${autorOriginal}</span>
                </p>
            </div>
            <p style="font-size: 0.8rem; color: #888; margin-top: 10px;">
                Estado: ${tipo.toUpperCase()} | Impreso el: ${new Date().toLocaleDateString()} a las ${new Date().toLocaleTimeString()}
            </p>
        </div>
    `;
    clone.insertBefore(header, clone.firstChild);

    // Contenedor temporal oculto
    const contenedorTemporal = document.createElement('div');
    contenedorTemporal.style.position = 'absolute';
    contenedorTemporal.style.left = '-9999px';
    contenedorTemporal.style.top = '0';
    contenedorTemporal.style.width = '750px'; // Ancho fijo para consistencia en PDF
    contenedorTemporal.style.backgroundColor = 'white';
    contenedorTemporal.style.padding = '20px';
    contenedorTemporal.appendChild(clone);
    document.body.appendChild(contenedorTemporal);

    // Generar PDF
    html2pdf().set(opt).from(clone).toPdf().output('datauristring').then(function (pdfAsString) {
        const base64 = pdfAsString.split(',')[1];

        if (typeof Android !== "undefined" && Android.guardarPDF) {
            Android.guardarPDF(base64, nombreArchivo);
        } else {
            html2pdf().set(opt).from(clone).save();
        }
        document.body.removeChild(contenedorTemporal);
    }).catch(err => {
        console.error("Error PDF:", err);
        if(document.body.contains(contenedorTemporal)) document.body.removeChild(contenedorTemporal);
        alert("‚ùå Error al generar el PDF.");
    });
}

    // --- FUNCIONES DE UTILIDAD para FUS ---

    function toggleFurFusFields(metodo) {
        const furFields = document.getElementById('fields-fur');
        const fusFields = document.getElementById('fields-fus');
        const furInput = document.getElementById('fur');
        const fusDateInput = document.getElementById('fus_date');

        if (metodo === 'FUR') {
            furFields.style.display = 'block';
            fusFields.style.display = 'none';
            furInput.required = true;
            fusDateInput.required = false;
        } else { // FUS
            furFields.style.display = 'none';
            fusFields.style.display = 'block';
            furInput.required = false;
            fusDateInput.required = true;
        }
    }

    function calcularFURDesdeUS(fusDate, semanas, dias) {
        const egDias = (semanas * 7) + dias;
        const fur = new Date(fusDate);
        fur.setDate(fur.getDate() - egDias);

        const year = fur.getFullYear();
        const month = String(fur.getMonth() + 1).padStart(2, '0');
        const day = String(fur.getDate()).padStart(2, '0');

        return `${year}-${month}-${day}`;
    }

    function getEffectiveFURDate(embarazada) {
        return crearFechaLocal(embarazada.fur);
    }

    const getVacunaStatus = (vacunaDate) => {
        if (!vacunaDate || vacunaDate === '') return 'Pendiente ‚ùå';
        return `Aplicada (${formatDate(crearFechaLocal(vacunaDate))}) ‚úÖ`;
    };

    // --- FUNCIONES PARA NOTAS IMPORTANTES (MODIFICADAS) ---

    // Encuentra el paciente por index y tipo (incluyendo archivadas)
    function getPacientePorIndex(index, tipo) {
        if (tipo === 'embarazada') return { lista: embarazadas, clave: 'embarazadas', paciente: embarazadas[index] };
        if (tipo === 'puerpera') return { lista: puerperas, clave: 'puerperas', paciente: puerperas[index] };
        if (tipo === 'archivada') return { lista: archivadas, clave: 'archivadas', paciente: archivadas[index] };
        return null;
    }

   function renderizarNotas(paciente, pacienteIndex, tipo) {
        if (!paciente.notas || paciente.notas.length === 0) {
            return '<p>No hay notas registradas para esta paciente.</p>';
        }

        let html = '<ul style="list-style: none; padding-left: 0; max-height: 250px; overflow-y: auto; padding-right: 15px;">';

        paciente.notas.forEach((nota, notaIndex) => {
            const isArchived = tipo === 'archivada';
            const notaId = `nota-item-${tipo}-${pacienteIndex}-${notaIndex}`;

            // --- L√ìGICA DE ETIQUETA VISUAL ---
            let etiquetaHtml = '';
            // Solo mostramos la etiqueta si estamos en Puerpera o Archivada, y si la nota tiene etapa
            if ((tipo === 'puerpera' || tipo === 'archivada') && nota.etapa) {
                let colorFondo = '#9e9e9e'; // Gris por defecto
                if (nota.etapa === 'Embarazo') colorFondo = '#673ab7'; // Morado
                else if (nota.etapa === 'Puerperio') colorFondo = '#e91e63'; // Rosa
                else if (nota.etapa === 'Sistema') colorFondo = '#2196f3'; // Azul

                etiquetaHtml = `<span style="background-color: ${colorFondo}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; margin-left: 8px; vertical-align: text-bottom; font-weight: normal;">${nota.etapa}</span>`;
            }

            html += `
                <li id="${notaId}" class="nota-item">
                    <p style="margin: 0 0 5px 0; font-weight: 600; color: #3f51b5;">
                     ${nota.fecha.split(',')[0]} ${etiquetaHtml}
                    </p>
                    <p class="nota-texto" style="margin: 0; white-space: pre-wrap;">${nota.texto}</p>
                    ${!isArchived ? `
                        <div class="nota-acciones">
                            <button onclick="iniciarEdicionNota(${pacienteIndex}, ${notaIndex}, '${tipo}')">‚úèÔ∏è Editar</button>
                            <button class="delete" onclick="eliminarNota(${pacienteIndex}, ${notaIndex}, '${tipo}')">üóëÔ∏è Eliminar</button>
                        </div>
                    ` : ''}
                </li>
            `;
        });

        html += '</ul>';
        return html;
    }


   function a√±adirNota(index, tipo) {
        const notaTextoId = `nueva-nota-${tipo}`;
        const notaTexto = document.getElementById(notaTextoId).value.trim();

        if (notaTexto === '') {
            alert('Por favor, ingresa el texto de la nota.');
            return;
        }

        const now = new Date();
        const fechaHora = now.toLocaleString('es-ES', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });

        // --- CAMBIO: DETERMINAR ETAPA ---
        let etapaLabel = 'General';
        if (tipo === 'embarazada') etapaLabel = 'Embarazo';
        else if (tipo === 'puerpera') etapaLabel = 'Puerperio';
        else if (tipo === 'archivada') etapaLabel = 'Archivo';

        const nuevaNota = {
            fecha: fechaHora,
            texto: notaTexto,
            etapa: etapaLabel // <--- Guardamos la etapa aqu√≠
        };

        const data = getPacientePorIndex(index, tipo);
        if (!data) return;

        if (!data.paciente.notas) {
            data.paciente.notas = [];
        }

        data.paciente.notas.unshift(nuevaNota);
        guardarDatos(data.clave);

        document.getElementById(notaTextoId).value = '';
        mostrarDetalle(index, tipo);
    }
    function iniciarEdicionNota(pacienteIndex, notaIndex, tipo) {
        const data = getPacientePorIndex(pacienteIndex, tipo);
        const nota = data.paciente.notas[notaIndex];
        const notaItem = document.getElementById(`nota-item-${tipo}-${pacienteIndex}-${notaIndex}`);

        if (!notaItem) return;

        // Reemplazar contenido con formulario de edici√≥n
        notaItem.innerHTML = `
            <p style="margin: 0 0 5px 0; font-weight: 600; color: #3f51b5;">${nota.fecha} (Editando)</p>
            <textarea id="edit-nota-texto-${pacienteIndex}-${notaIndex}" rows="4" style="width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 8px;">${nota.texto}</textarea>
            <div class="nota-acciones" style="text-align: right;">
                <button style="color: #4CAF50;" onclick="guardarEdicionNota(${pacienteIndex}, ${notaIndex}, '${tipo}')">üíæ Guardar</button>
                <button class="delete" onclick="mostrarDetalle(${pacienteIndex}, '${tipo}')">‚ùå Cancelar</button>
            </div>
        `;
    }

    function guardarEdicionNota(pacienteIndex, notaIndex, tipo) {
        const nuevoTexto = document.getElementById(`edit-nota-texto-${pacienteIndex}-${notaIndex}`).value.trim();

        if (nuevoTexto === '') {
            alert('La nota no puede estar vac√≠a.');
            return;
        }

        const data = getPacientePorIndex(pacienteIndex, tipo);
        if (!data) return;

        data.paciente.notas[notaIndex].texto = nuevoTexto;
        guardarDatos(data.clave);
        alert('‚úÖ Nota modificada con √©xito.');
        mostrarDetalle(pacienteIndex, tipo); // Recargar el detalle
    }

    function eliminarNota(pacienteIndex, notaIndex, tipo) {
        const data = getPacientePorIndex(pacienteIndex, tipo);
        if (!data) return;

        const confirmacion = confirm('‚ö†Ô∏è ¬øEst√° seguro que desea eliminar esta nota?');

        if (confirmacion) {
            data.paciente.notas.splice(notaIndex, 1);
            guardarDatos(data.clave);
            alert('üóëÔ∏è Nota eliminada.');
            mostrarDetalle(pacienteIndex, tipo); // Recargar el detalle
        }
    }

    // --- FUNCIONES DE NAVEGACI√ìN Y VISUALIZACI√ìN ---

    function mostrarSeccion(id) {
        renderizarAlertas();
        listContainerEmb.classList.remove('consulta-activa');
        listContainerPuerp.classList.remove('consulta-activa');
        if (listContainerArch) listContainerArch.classList.remove('consulta-activa'); // Reiniciar listado archivado

        document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));

        document.getElementById(id).classList.add('active');

        if (id === 'registro') {
            regresarAMenuRegistro();
        } else if (id === 'listado-embarazadas') {
            detalleEmbDiv.innerHTML = '';
            renderizarListadoEmbarazadas();
        } else if (id === 'listado-puerperas') {
            detallePuerpDiv.innerHTML = '';
            renderizarListadoPuerperas();
        } else if (id === 'listado-archivadas') { // NUEVO: Listado de archivadas
            detalleArchDiv.innerHTML = '';
            renderizarListadoArchivadas();
        }
    }

    function mostrarRegistroSub(id) {
        menuRegistroTipo.style.display = 'none';

        document.querySelectorAll('#registro .sub-section').forEach(sub => sub.classList.remove('active'));

        document.getElementById(id).classList.add('active');
    }

    function iniciarRegistroDirecto(tipo) {
        mostrarSeccion('registro');

        menuRegistroTipo.style.display = 'none';

        if (tipo === 'embarazada') {
            document.getElementById('registro-form-embarazada').reset();
            document.getElementById('form-embarazada').classList.add('active');
            document.getElementById('form-puerpera').classList.remove('active');
            document.querySelector('input[name="metodo_calc"][value="FUR"]').checked = true;
            toggleFurFusFields('FUR');
        } else if (tipo === 'puerpera') {
            document.getElementById('form-puerpera').classList.add('active');
            document.getElementById('form-embarazada').classList.remove('active');
        }
    }

    function regresarAMenuRegistro() {
        document.getElementById('form-embarazada').classList.remove('active');
        document.getElementById('form-puerpera').classList.remove('active');

        if (document.querySelector('input[name="metodo_calc"]')) {
            document.querySelector('input[name="metodo_calc"][value="FUR"]').checked = true;
            toggleFurFusFields('FUR');
        }

        menuRegistroTipo.style.display = 'block';
    }

    function regresarAListado(tipo) {
        if (tipo === 'embarazada') {
             listContainerEmb.classList.remove('consulta-activa');
             detalleEmbDiv.innerHTML = '';
             renderizarListadoEmbarazadas();
        } else if (tipo === 'puerpera') {
             listContainerPuerp.classList.remove('consulta-activa');
             detallePuerpDiv.innerHTML = '';
             renderizarListadoPuerperas();
        } else if (tipo === 'archivada') {
             listContainerArch.classList.remove('consulta-activa');
             detalleArchDiv.innerHTML = '';
             renderizarListadoArchivadas();
        }
    }

    function renderizarListadoEmbarazadas() {
        const ul = document.getElementById('lista-nombres-embarazadas');
        ul.innerHTML = '';

        if (embarazadas.length === 0) {
            ul.innerHTML = '<li>No hay pacientes registradas.</li>';
            return;
        }

        embarazadas.forEach((p, index) => {
            const li = document.createElement('li');
            li.textContent = p.nombre;
            li.onclick = () => mostrarDetalle(index, 'embarazada');
            ul.appendChild(li);
        });
    }

    function renderizarListadoPuerperas() {
        const ul = document.getElementById('lista-nombres-puerperas');
        ul.innerHTML = '';

        if (puerperas.length === 0) {
            ul.innerHTML = '<li>No hay pacientes registradas.</li>';
            return;
        }

        puerperas.forEach((p, index) => {
            const li = document.createElement('li');
            li.textContent = p.nombre;
            li.onclick = () => mostrarDetalle(index, 'puerpera');
            ul.appendChild(li);
        });
    }

    // NUEVA FUNCI√ìN PARA RENDERIZAR ARCHIVADAS (CORREGIDA)
    function renderizarListadoArchivadas() {
        actualizarSelectorAnios();
        const ul = document.getElementById('lista-nombres-archivadas');
        ul.innerHTML = '';

        if (archivadas.length === 0) {
            ul.innerHTML = '<li>No hay pacientes archivadas.</li>';
            return;
        }

        // Ordenar por tipo y luego por nombre para la visualizaci√≥n
        const sortedArchivadas = [...archivadas].sort((a, b) => a.tipo.localeCompare(b.tipo) || a.nombre.localeCompare(b.nombre));

        sortedArchivadas.forEach((p) => {
            // CORRECCI√ìN: Buscamos el √≠ndice real en la lista original 'archivadas'
            const originalIndex = archivadas.indexOf(p);

            const li = document.createElement('li');
            li.textContent = `[${p.tipo === 'embarazada' ? 'E' : 'P'}] ${p.nombre}`;

            // Usamos originalIndex en lugar de index
            li.onclick = () => mostrarDetalleArchivada(originalIndex);

            ul.appendChild(li);
        });
    }

// --- FUNCI√ìN PARA MOSTRAR/OCULTAR HISTORIAL EMBARAZO ---
     function toggleHistorial(index) {
         const div = document.getElementById(`historial-embarazo-${index}`);
         if (div.style.display === 'none') {
         div.style.display = 'block';
         div.style.animation = 'fadeIn 0.5s';
         } else {
        div.style.display = 'none';
    }
}

        function mostrarDetalle(index, tipo) {
        const targetDiv = (tipo === 'embarazada') ? detalleEmbDiv : detallePuerpDiv;
        const targetContainer = (tipo === 'embarazada') ? listContainerEmb : listContainerPuerp;

        targetContainer.classList.add('consulta-activa');
        targetDiv.innerHTML = '';

        // ==========================================
        // L√ìGICA PARA EMBARAZADA
        // ==========================================
        if (tipo === 'embarazada') {
            const p = embarazadas[index];
            const furDate = getEffectiveFURDate(p);

            // Datos b√°sicos
            let edadDisplay = p.fecha_nacimiento ? `${calcularEdad(crearFechaLocal(p.fecha_nacimiento))} a√±os` : 'N/A';
            const fppDate = calcularFPP(furDate);
            const gestacion = calcularEdadGestacional(furDate);

            // L√≥gica de visualizaci√≥n de semanas (Color y mensaje)
            let highlightClass = 'dato-destacado-box';
            let restanteMsg;
            if (gestacion.diasRestantes <= 0) {
                highlightClass += ' alerta';
                restanteMsg = `‚ö†Ô∏è Parto completado o Post-T√©rmino`;
            } else {
                const semanasRestantes = Math.ceil(gestacion.diasRestantes / 7);
                restanteMsg = `FPP estimada en ${semanasRestantes} semanas`;
            }

            // L√≥gica Fuente de c√°lculo
            let fuenteTexto = (p.metodo === 'FUS') ? `Ultrasonido (${formatDate(crearFechaLocal(p.fus_date))})` : 'Fecha √öltima Regla';
            let furLabel = (p.metodo === 'FUS') ? 'FUR Calculada' : 'FUR';

            // Helper para vacunas
            const v = p.vacunas || {};
            const checkVac = (date) => date ? `<span class="status-ok">Aplicada el ${formatDate(crearFechaLocal(date))}</span>` : `<span class="status-pending">Pendiente</span>`;

            // HTML ESTRUCTURA DE FICHA EMBARAZADA
            targetDiv.innerHTML = `
                <div id="vista-info-emb-${index}" class="ficha-container">
                    <div class="ficha-header header-emb">
                        <div>
                            <h3>${p.nombre}</h3>
                            <small style="opacity:0.9">ID/Exp: ${index + 1}</small>
                        </div>
                        <span class="ficha-badge">ü§∞ Embarazada</span>
                    </div>

                    <div class="ficha-body">
                        <div class="${highlightClass}">
                            <span class="dato-label">Edad Gestacional Actual</span>
                            <span class="dato-grande">${gestacion.semanas} Semanas <small style="font-size:0.5em">+ ${gestacion.dias} d√≠as</small></span>
                            <span class="dato-sub">${restanteMsg}</span>
                        </div>

                        <div class="datos-grid">
                            <div class="dato-item">
                                <span class="dato-label">Edad Paciente</span>
                                <span class="dato-valor">${edadDisplay}</span>
                            </div>

							<div class="dato-item">
                                <span class="dato-label">Direcci√≥n</span>
                                <span class="dato-valor">${p.direccion || 'No especificada'}</span>
                            </div>
                            <div class="dato-item">
                                <span class="dato-label">Fecha Probable Parto</span>
                                <span class="dato-valor" style="color:#d81b60">${formatDate(fppDate)}</span>
                            </div>
                            <div class="dato-item">
                                <span class="dato-label">${furLabel}</span>
                                <span class="dato-valor">${formatDate(furDate)}</span>
                            </div>
                            <div class="dato-item">
                                <span class="dato-label">C√°lculo Basado en</span>
                                <span class="dato-valor">${fuenteTexto}</span>
                            </div>
                        </div>

                        <h4 class="seccion-titulo">üíâ Esquema de Vacunaci√≥n</h4>
                        <table class="tabla-vacunas">
                            <tr><td width="30%"><strong>Influenza</strong></td><td>${checkVac(v.influenza)}</td></tr>
                            <tr><td><strong>DTPa</strong></td><td>${checkVac(v.dtpa)}</td></tr>
                            <tr><td><strong>DT Adulto</strong></td><td>${checkVac(v.dtadulto)}</td></tr>
                            <tr><td><strong>VRS</strong></td><td>${checkVac(v.vrs)}</td></tr>
                        </table>

                        <h4 class="seccion-titulo">üìù Notas Cl√≠nicas (${p.notas ? p.notas.length : 0})</h4>
                        <div id="notas-list-emb-${index}">
                            ${renderizarNotas(p, index, 'embarazada')}
                        </div>
                    </div>
                </div>

                <form onsubmit="event.preventDefault(); a√±adirNota(${index}, 'embarazada');" style="margin-top: 15px; padding: 0 10px;">
                    <textarea id="nueva-nota-embarazada" rows="2" placeholder="Escribir nueva nota..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;"></textarea>
                    <button type="submit" class="btn-guardar" style="margin-top: 5px; padding: 8px;">Agregar Nota</button>
                </form>

                <div class="control-panel">
                    <div class="control-header">Acciones del Expediente</div>
                    <div class="btn-grid">
                        <button class="btn-pro pro-birth full-width" onclick="finalizarEmbarazo(${index})">
                            <span>üë∂</span> ¬°Registrar Parto/Aborto! (Pasar a Puerperio)
                        </button>
                        <button class="btn-pro pro-pdf full-width" onclick="descargarPDF(${index}, 'embarazada')">
                            <span>üìÑ</span> Descargar ficha PDF
                        </button>
                        <button class="btn-pro pro-edit" onclick="iniciarEdicion(${index}, 'embarazada')">
                            <span>‚úèÔ∏è</span> Editar
                        </button>
                        <button class="btn-pro pro-archive" onclick="archivarPaciente(${index}, 'embarazada')">
                            <span>üì¶</span> Archivar
                        </button>
                        <button class="btn-pro pro-delete full-width" onclick="eliminarPaciente(${index}, 'embarazada')">
                            <span>üóëÔ∏è</span> Eliminar
                        </button>
                        <button class="btn-pro pro-back" onclick="regresarAListado('embarazada')">
                            ‚Üê Volver al Listado
                        </button>
                    </div>
                </div>
            `;

        // ==========================================
        // L√ìGICA PARA PU√âRPERA (CON SEMANAS AL NACER AGREGADO)
        // ==========================================
        } else if (tipo === 'puerpera') {
            const p = puerperas[index];
            const fpDate = crearFechaLocal(p.fp);
            let edadDisplay = p.fecha_nacimiento ? `${calcularEdad(crearFechaLocal(p.fecha_nacimiento))} a√±os` : 'N/A';
            const puerperio = calcularPuerperio(fpDate);
            const seg = calcularFechasSeguimientoPuerpera(fpDate);

            // Estilos condicionales
            let highlightClass = 'dato-destacado-box';
            let estadoMsg;
            if (puerperio.diasRestantes <= 0) {
                 highlightClass += ' alerta';
                 estadoMsg = `Puerperio finalizado hace ${Math.abs(puerperio.diasRestantes)} d√≠as`;
            } else {
                 estadoMsg = `Faltan ${puerperio.diasRestantes} d√≠as para el alta`;
            }

            // Helper seguimiento
            const rowSeg = (label, date) => `
                <div class="dato-item">
                    <span class="dato-label">${label}</span>
                    <span class="dato-valor">${formatDate(date)}</span>
                </div>`;

            // --- L√ìGICA HISTORIAL Y SEMANAS AL NACER ---
            let botonHistorialHTML = '';
            let contenedorHistorialHTML = '';

            if (p.historial_embarazo) {
                const h = p.historial_embarazo;
                const vac = h.vacunas || {};

                // CALCULO DE SEMANAS AL NACER
                const furEfectiva = getEffectiveFURDate(h); // Usamos la misma funci√≥n que para embarazadas pero pasamos el historial
                const semanasAlNacer = calcularEdadGestacionalAlParto(furEfectiva, fpDate);

                const checkV = (date) => date ? `<span class="status-ok">S√≠ (${formatDate(crearFechaLocal(date))})</span>` : `<span class="status-pending">No</span>`;

                botonHistorialHTML = `
                    <button onclick="toggleHistorial(${index})" style="background-color: #673ab7; color: white; border:none; padding: 10px; width:100%; border-radius: 8px; margin-bottom: 15px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span>üìú</span> Ver Historial de Embarazo Anterior
                    </button>
                `;

                contenedorHistorialHTML = `
                    <div id="historial-embarazo-${index}" style="display: none; background-color: #f3e5f5; padding: 15px; border-radius: 8px; border-left: 5px solid #673ab7; margin-bottom: 20px;">
                        <h4 style="color: #673ab7; margin-top: 0;">ü§∞ Historial del Embarazo Finalizado</h4>

                        <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #d1c4e9; text-align: center;">
                             <span style="font-size: 0.8em; color: #673ab7; font-weight: bold; text-transform: uppercase;">Finaliz√≥ a las:</span>
                             <div style="font-size: 1.4em; font-weight: bold; color: #4a148c;">${semanasAlNacer}</div>
                        </div>

                        <div class="datos-grid">
                            <div class="dato-item">
                                <span class="dato-label">M√©todo C√°lculo</span>
                                <span class="dato-valor">${h.metodo}</span>
                            </div>
                            <div class="dato-item">
                                <span class="dato-label">FUR / FUS</span>
                                <span class="dato-valor">${h.metodo === 'FUR' ? formatDate(crearFechaLocal(h.fur)) : formatDate(crearFechaLocal(h.fus_date))}</span>
                            </div>
                        </div>

                        <h5 style="color: #4a148c; border-bottom: 1px solid #d1c4e9; margin-bottom: 5px;">üíâ Vacunas Aplicadas en Embarazo</h5>
                        <ul style="list-style: none; padding: 0; font-size: 0.9em;">
                            <li><strong>Influenza:</strong> ${checkV(vac.influenza)}</li>
                            <li><strong>DTPa:</strong> ${checkV(vac.dtpa)}</li>
                            <li><strong>DT Adulto:</strong> ${checkV(vac.dtadulto)}</li>
                            <li><strong>VRS:</strong> ${checkV(vac.vrs)}</li>
                        </ul>
                    </div>
                `;
            }
            // ------------------------------------------

            targetDiv.innerHTML = `
                <div id="vista-info-puerp-${index}" class="ficha-container">
                    <div class="ficha-header header-puerp">
                        <div>
                            <h3>${p.nombre}</h3>
                            <small style="opacity:0.9">ID/Exp: ${index + 1}</small>
                        </div>
                        <span class="ficha-badge">ü§± Pu√©rpera</span>
                    </div>

                    <div class="ficha-body">
                        ${botonHistorialHTML}
                        ${contenedorHistorialHTML}

                        <div class="${highlightClass}">
                            <span class="dato-label">Progreso del Puerperio</span>
                            <span class="dato-grande">${puerperio.diasPuerperio} <small>d√≠as transcurridos</small></span>
                            <span class="dato-sub">${estadoMsg}</span>
                        </div>

                        <div class="datos-grid">
                            <div class="dato-item">
                                <span class="dato-label">Edad Paciente</span>
                                <span class="dato-valor">${edadDisplay}</span>
                            </div>
							<div class="dato-item">
                                <span class="dato-label">Direcci√≥n</span>
                                <span class="dato-valor">${p.direccion || 'No especificada'}</span>
                            </div>
                            <div class="dato-item">
                                <span class="dato-label">Fecha de Parto</span>
                                <span class="dato-valor">${formatDate(fpDate)}</span>
                            </div>
                            <div class="dato-item">
                                <span class="dato-label">Fin Puerperio (42 d√≠as)</span>
                                <span class="dato-valor" style="color:#e91e63; font-weight:bold;">${formatDate(puerperio.finPuerperioDate)}</span>
                            </div>
                        </div>

                        <h4 class="seccion-titulo">üóìÔ∏è Calendario de Seguimiento</h4>
                        <div class="datos-grid">
                            ${rowSeg('Detecci√≥n (24h)', seg['24 horas'])}
                            ${rowSeg('Control 3 D√≠as', seg['3 d√≠as'])}
                            ${rowSeg('Control 7 D√≠as', seg['7 d√≠as'])}
                            ${rowSeg('Control 15 D√≠as', seg['15 d√≠as'])}
                            ${rowSeg('Control 28 D√≠as', seg['28 d√≠as'])}
                        </div>

                        <h4 class="seccion-titulo">üìù Notas Cl√≠nicas (${p.notas ? p.notas.length : 0})</h4>
                        <div id="notas-list-puerp-${index}">
                            ${renderizarNotas(p, index, 'puerpera')}
                        </div>
                    </div>
                </div>

                <form onsubmit="event.preventDefault(); a√±adirNota(${index}, 'puerpera');" style="margin-top: 15px; padding: 0 10px;">
                    <textarea id="nueva-nota-puerpera" rows="2" placeholder="Escribir nueva nota..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;"></textarea>
                    <button type="submit" class="btn-guardar" style="margin-top: 5px; padding: 8px;">Agregar Nota</button>
                </form>


                <div class="control-panel">
                    <div class="control-header">Acciones del Expediente</div>
                    <div class="btn-grid">
                        <button class="btn-pro pro-pdf full-width" onclick="descargarPDF(${index}, 'puerpera')">
                            <span>üìÑ</span> Descargar Ficha PDF
                        </button>

                        <button class="btn-pro pro-edit" onclick="iniciarEdicion(${index}, 'puerpera')">
                            <span>‚úèÔ∏è</span> Corregir
                        </button>
                        <button class="btn-pro pro-archive" onclick="archivarPaciente(${index}, 'puerpera')">
                            <span>üì¶</span> Archivar
                        </button>

                        <button class="btn-pro pro-delete full-width" onclick="eliminarPaciente(${index}, 'puerpera')">
                            <span>üóëÔ∏è</span> Eliminar Paciente
                        </button>

                        <button class="btn-pro pro-back full-width" onclick="regresarAListado('puerpera')">
                            ‚Üê Volver al Listado
                        </button>
                    </div>
                </div>

            `;
        }
    }

       async function mostrarDetalleArchivada(index) {
    try {
        let p = archivadas[index];
        if (!p) return;

        // --- 1. REPARACI√ìN DE DATOS (Blindaje para evitar pantalla en blanco) ---
        const repararDato = (dato, defecto) => {
            if (!dato) return defecto;
            if (typeof dato === 'object') return dato;
            try { return JSON.parse(dato); } catch (e) { return defecto; }
        };

        p.notas = repararDato(p.notas, []);
        p.vacunas = repararDato(p.vacunas, {});
        p.historial_embarazo = repararDato(p.historial_embarazo, null);

        // Si el tipo no existe, intentamos deducirlo para que no falle la l√≥gica
        if (!p.tipo) {
            p.tipo = (p.fp || p.historial_embarazo) ? 'puerpera' : 'embarazada';
        }

        // --- 2. ORDENAR NOTAS (Antiguas arriba) ---
        if (p.notas && Array.isArray(p.notas)) {
            p.notas.sort((a, b) => {
                const fA = a.fechaFull ? new Date(a.fechaFull) : new Date();
                const fB = b.fechaFull ? new Date(b.fechaFull) : new Date();
                return fA - fB;
            });
        }

        listContainerArch.classList.add('consulta-activa');
        detalleArchDiv.innerHTML = '';

        // Datos comunes
        const fnDisplay = p.fecha_nacimiento ? formatDate(crearFechaLocal(p.fecha_nacimiento)) : 'N/A';
        const fechaArchivo = p.fecha_archivo ? formatDate(crearFechaLocal(p.fecha_archivo)) : 'Desconocida';

        let contenidoEspecifico = '';

        // --- CASO 1: ARCHIVADA DESDE EMBARAZO ---
        if (p.tipo === 'embarazada') {
            const furDate = getEffectiveFURDate(p);
            const v = p.vacunas || {};
            const checkVac = (date) => date ? `<span class="status-ok">S√≠ (${formatDate(crearFechaLocal(date))})</span>` : `<span class="status-pending">No registrada</span>`;

            contenidoEspecifico = `
                <div class="dato-destacado-box" style="background-color: #eceff1; border-left: 5px solid #607d8b;">
                    <span class="dato-label">Motivo de Archivo</span>
                    <span class="dato-grande">Embarazo Finalizado</span>
                    <span class="dato-sub">Archivada directamente desde etapa gestacional</span>
                </div>
                <h4 class="seccion-titulo">ü§∞ Datos del Embarazo</h4>
                <div class="datos-grid">
                    <div class="dato-item"><span class="dato-label">FUR / FUS</span><span class="dato-valor">${formatDate(furDate)}</span></div>
                    <div class="dato-item"><span class="dato-label">M√©todo C√°lculo</span><span class="dato-valor">${p.metodo || 'N/A'}</span></div>
                </div>
                <h4 class="seccion-titulo">üíâ Registro de Vacunaci√≥n</h4>
                <table class="tabla-vacunas">
                    <tr><td width="40%"><strong>Influenza</strong></td><td>${checkVac(v.influenza)}</td></tr>
                    <tr><td><strong>DTPa</strong></td><td>${checkVac(v.dtpa)}</td></tr>
                    <tr><td><strong>DT Adulto</strong></td><td>${checkVac(v.dtadulto)}</td></tr>
                    <tr><td><strong>VRS</strong></td><td>${checkVac(v.vrs)}</td></tr>
                </table>
            `;
        } 
        // --- CASO 2: ARCHIVADA DESDE PUERPERIO ---
        else {
            const fpDate = crearFechaLocal(p.fp);
            let historialHTML = '';

            if (p.historial_embarazo) {
                const h = p.historial_embarazo;
                const vac = h.vacunas || {};
                const furEfectiva = getEffectiveFURDate(h);
                const semanasAlNacer = calcularEdadGestacionalAlParto(furEfectiva, fpDate);
                const checkV = (date) => date ? `<span class="status-ok">S√≠ (${formatDate(crearFechaLocal(date))})</span>` : `<span class="status-pending">No</span>`;

                historialHTML = `
                    <div style="margin-top: 25px; padding: 15px; background: #f3e5f5; border: 1px solid #ce93d8; border-radius: 8px; border-left: 5px solid #673ab7;">
                        <h4 style="margin-top:0; color: #673ab7; border-bottom: 1px solid #d1c4e9; padding-bottom: 5px;">üìú Historial del Embarazo Anterior</h4>
                        <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #d1c4e9; text-align: center;">
                             <span style="font-size: 0.8em; color: #673ab7; font-weight: bold; text-transform: uppercase;">Finaliz√≥ a las:</span>
                             <div style="font-size: 1.4em; font-weight: bold; color: #4a148c;">${semanasAlNacer}</div>
                        </div>
                        <div class="datos-grid">
                            <div class="dato-item"><span class="dato-label">FUR de ese embarazo</span><span class="dato-valor">${formatDate(furEfectiva)}</span></div>
                            <div class="dato-item"><span class="dato-label">M√©todo de C√°lculo</span><span class="dato-valor">${h.metodo || 'FUR'}</span></div>
                        </div>
                        <h5 style="color: #4a148c; margin-bottom: 5px;">üíâ Vacunas aplicadas en ese periodo:</h5>
                        <ul style="list-style: none; padding: 0; font-size: 0.85em; color: #333;">
                            <li>‚Ä¢ Influenza: ${checkV(vac.influenza)}</li>
                            <li>‚Ä¢ DTPa: ${checkV(vac.dtpa)}</li>
                            <li>‚Ä¢ DT Adulto: ${checkV(vac.dtadulto)}</li>
                            <li>‚Ä¢ VRS: ${checkV(vac.vrs)}</li>
                        </ul>
                    </div>
                `;
            }

            contenidoEspecifico = `
                <div class="dato-destacado-box" style="background-color: #e3f2fd; border-left: 5px solid #2196f3;">
                    <span class="dato-label">Estado del Expediente</span>
                    <span class="dato-grande">Ciclo Materno Concluido</span>
                </div>
                <h4 class="seccion-titulo">ü§± Datos del Parto/Aborto y Puerperio</h4>
                <div class="datos-grid">
                    <div class="dato-item"><span class="dato-label">Fecha de Parto/Aborto (FP)</span><span class="dato-valor">${formatDate(fpDate)}</span></div>
                    <div class="dato-item"><span class="dato-label">Fin Puerperio</span><span class="dato-valor">${formatDate(calcularFinPuerperio(fpDate))}</span></div>
                </div>
                ${historialHTML} 
            `;
        }

        // --- RENDERIZADO FINAL ---
        detalleArchDiv.innerHTML = `
            <div id="vista-info-arch-${index}" class="ficha-container" style="border-top: 5px solid #607d8b;">
                <div class="ficha-header header-arch">
                    <div>
                        <h3>${p.nombre}</h3>
                        <small>Fecha de Archivo: ${fechaArchivo}</small>
                    </div>
                    <span class="ficha-badge">üì¶ Expediente Hist√≥rico</span>
                </div>
                <div class="ficha-body">
                    <div class="datos-grid">
                        <div class="dato-item"><span class="dato-label">Edad Actual</span><span class="dato-valor">${p.fecha_nacimiento ? calcularEdad(crearFechaLocal(p.fecha_nacimiento)) + ' a√±os' : 'N/A'}</span></div>
                        <div class="dato-item"><span class="dato-label">Fecha Nacimiento</span><span class="dato-valor">${fnDisplay}</span></div>
                        <div class="dato-item" style="grid-column: span 2;">
                            <span class="dato-label">üè† Direcci√≥n</span>
                            <span class="dato-valor">${p.direccion || 'No registrada'}</span>
                        </div>
                    </div>
                    ${contenidoEspecifico}
                    <h4 class="seccion-titulo" style="margin-top: 30px;">üìù Historial Completo de Notas</h4>
                    <div style="max-height: none; overflow: visible;">
                        ${renderizarNotas(p, index, 'archivada')}
                    </div>
                </div>
            </div>

            <div class="control-panel" style="border-top: 4px solid #607d8b;">
                <div class="control-header">Gesti√≥n de Archivo</div>
                <div class="btn-grid">
                    <button class="btn-pro pro-pdf full-width" onclick="descargarPDF(${index}, 'archivada')">
                        <span>üìÑ</span> Ficha PDF Completa
                    </button>
                    <button class="btn-pro full-width" style="background: linear-gradient(135deg, #ffa000, #ff6f00);" onclick="restaurarPaciente(${index})">
                        <span>üîÑ</span> Restaurar a Lista Activa
                    </button>
                    <button class="btn-pro pro-delete full-width" onclick="eliminarPaciente(${index}, 'archivada')">
                        <span>üóëÔ∏è</span> Eliminar Definitivamente
                    </button>
                    <button class="btn-pro pro-back" onclick="regresarAListado('archivada')">‚Üê Volver</button>
                    <button class="btn-pro pro-back" onclick="mostrarSeccion('inicio')">üè† Men√∫</button>
                </div>
            </div>
        `;
    } catch (error) {
        console.error("Error en Archivada:", error);
        detalleArchDiv.innerHTML = `<div style="padding:20px; color:red; text-align:center;"><h3>‚ö†Ô∏è Error de Integridad</h3><button onclick="regresarAListado('archivada')">Volver</button></div>`;
    }
}



    // NUEVA FUNCI√ìN PARA ARICHIVAR PACIENTE
    function archivarPaciente(index, tipo) {
        let paciente;
        let listaActual;
        let listaNombre;

        if (tipo === 'embarazada') {
            paciente = embarazadas.splice(index, 1)[0];
            listaActual = 'embarazadas';
            listaNombre = 'Embarazadas';
        } else if (tipo === 'puerpera') {
            paciente = puerperas.splice(index, 1)[0];
            listaActual = 'puerperas';
            listaNombre = 'Pu√©rperas';
        }

        if (paciente) {
            paciente.tipo = tipo; // A√±adir el tipo original antes de archivar
            paciente.fecha_archivo = obtenerFechaLocalISO();
            archivadas.push(paciente);

            guardarDatos(listaActual);
            guardarDatos('archivadas');

            alert(`‚úÖ Paciente ${paciente.nombre} archivada correctamente. Ahora est√° en la lista de Pacientes Archivadas.`);
            regresarAListado(tipo);
        }
    }

    // NUEVA FUNCI√ìN PARA RESTAURAR PACIENTE
    function restaurarPaciente(index) {
        const paciente = archivadas.splice(index, 1)[0];

        if (paciente) {
            const tipo = paciente.tipo;
            delete paciente.tipo;
            delete paciente.fecha_archivo;

            if (tipo === 'embarazada') {
                embarazadas.push(paciente);
                guardarDatos('embarazadas');
            } else if (tipo === 'puerpera') {
                puerperas.push(paciente);
                guardarDatos('puerperas');
            }

            guardarDatos('archivadas');

            alert(`‚úÖ Paciente ${paciente.nombre} restaurada a la lista de ${tipo === 'embarazada' ? 'Embarazadas' : 'Pu√©rperas'}.`);

            regresarAListado('archivada'); // Vuelve al listado de archivadas
        }
    }

    // FUNCI√ìN DE ELIMINAR PACIENTE MODIFICADA
    function eliminarPaciente(index, tipo) {
        let lista;
        let listaNombre;
        let claveGuardado;

        if (tipo === 'embarazada') {
            lista = embarazadas;
            claveGuardado = 'embarazadas';
            listaNombre = 'Embarazadas';
        } else if (tipo === 'puerpera') {
            lista = puerperas;
            claveGuardado = 'puerperas';
            listaNombre = 'Pu√©rperas';
        } else if (tipo === 'archivada') {
            lista = archivadas;
            claveGuardado = 'archivadas';
            listaNombre = 'Archivadas';
        }

        const nombre = lista[index].nombre;

        const confirmMsg = `‚ö†Ô∏è ¬øEst√°s seguro de que deseas ELIMINAR PERMANENTEMENTE a ${nombre} del registro de ${listaNombre}? Esta acci√≥n NO se puede deshacer.`;

        if (confirm(confirmMsg)) {
            lista.splice(index, 1);
            guardarDatos(claveGuardado);

            alert(`üóëÔ∏è Paciente ${nombre} eliminada permanentemente.`);

            regresarAListado(tipo);
        }
    }

    // --- FUNCIONES DE EDICI√ìN ---

    function iniciarEdicion(index, tipo) {
        const p = (tipo === 'embarazada') ? embarazadas[index] : puerperas[index];
        const fechaKey = (tipo === 'embarazada') ? 'fur' : 'fp';

        const fechaEtiqueta = (tipo === 'embarazada')
            ? (p.metodo === 'FUS' ? 'Nueva FUR Equivalente' : 'Nueva FUR')
            : 'Nueva FP';

        const contenedorInfo = document.getElementById(`vista-info-${(tipo === 'embarazada') ? 'emb' : 'puerp'}-${index}`);
        const fnValue = p.fecha_nacimiento || '';

        const vacunas = p.vacunas || {};

        contenedorInfo.innerHTML = `
            <h3>Corregir Datos de ${p.nombre}</h3>
            <form onsubmit="event.preventDefault(); guardarEdicion(${index}, '${tipo}');">
                <label for="edit-nombre">Nuevo Nombre:</label>
                <input type="text" id="edit-nombre-${tipo}" value="${p.nombre}" required>

                <label for="edit-fn">Nueva Fecha de Nacimiento (Opcional):</label>
                <input type="date" id="edit-fn-${tipo}" value="${fnValue}">

				<label for="edit-dir">Direcci√≥n:</label>
                <input type="text" id="edit-dir-${tipo}" value="${p.direccion || ''}">

                <label for="edit-fecha">${fechaEtiqueta}:</label>
                <input type="date" id="edit-fecha-${tipo}" value="${p[fechaKey]}" required>

                ${tipo === 'embarazada' ? `
                    <hr>
                    <h4>üíâ Corregir Fechas de Vacunas</h4>
                    <label for="edit-influenza">Influenza:</label>
                    <input type="date" id="edit-influenza-embarazada" value="${vacunas.influenza || ''}">

                    <label for="edit-dtpa">DTPa:</label>
                    <input type="date" id="edit-dtpa-embarazada" value="${vacunas.dtpa || ''}">

                    <label for="edit-dtadulto">DT Adulto:</label>
                    <input type="date" id="edit-dtadulto-embarazada" value="${vacunas.dtadulto || ''}">

                    <label for="edit-vrs">VRS:</label>
                    <input type="date" id="edit-vrs-embarazada" value="${vacunas.vrs || ''}">
                ` : ''}

                <div class="detalle-actions" style="margin-top: 15px;">
                    <button type="submit" class="btn-guardar" style="max-width: 300px;">üíæ Guardar Cambios</button>
                    <button type="button" class="btn-accion eliminar" style="background-color: #7986cb;" onclick="mostrarDetalle(${index}, '${tipo}')" style="max-width: 300px;">Cancelar</button>
                </div>
            </form>
        `;
    }

    function guardarEdicion(index, tipo) {
        const nuevoNombre = document.getElementById(`edit-nombre-${tipo}`).value.trim();
    const nuevaFechaNacimiento = document.getElementById(`edit-fn-${tipo}`).value;
    const nuevaDireccion = document.getElementById(`edit-dir-${tipo}`).value.trim(); // <--- NUEVO
    const nuevaFechaPrincipal = document.getElementById(`edit-fecha-${tipo}`).value;

    if (nuevoNombre && nuevaFechaPrincipal) {
        if (tipo === 'embarazada') {
                const nuevaInfluenza = document.getElementById('edit-influenza-embarazada').value;
                const nuevaDTPa = document.getElementById('edit-dtpa-embarazada').value;
                const nuevaDTAdulto = document.getElementById('edit-dtadulto-embarazada').value;
                const nuevaVRS = document.getElementById('edit-vrs-embarazada').value;

                embarazadas[index].nombre = nuevoNombre;
            embarazadas[index].fecha_nacimiento = nuevaFechaNacimiento;
            embarazadas[index].direccion = nuevaDireccion; // <--- AGREGAR ESTO
            embarazadas[index].fur = nuevaFechaPrincipal;

                embarazadas[index].vacunas = {
                    influenza: nuevaInfluenza,
                    dtpa: nuevaDTPa,
                    dtadulto: nuevaDTAdulto,
                    vrs: nuevaVRS
                };
                embarazadas[index].metodo = embarazadas[index].metodo || 'FUR';

                guardarDatos('embarazadas');
            } else if (tipo === 'puerpera') {
            puerperas[index].nombre = nuevoNombre;
            puerperas[index].fecha_nacimiento = nuevaFechaNacimiento;
            puerperas[index].direccion = nuevaDireccion; // <--- AGREGAR ESTO
            puerperas[index].fp = nuevaFechaPrincipal;

            guardarDatos('puerperas');
        }

            alert(`‚úÖ Datos de ${nuevoNombre} corregidos con √©xito.`);

            mostrarDetalle(index, tipo);
        } else {
            alert('Por favor, ingresa un nombre y la fecha principal (FUR/FP) v√°lidos.');
        }
    }

    // --- MANEJO DE REGISTRO ---
// REEMPLAZA EL EVENTO DE REGISTRO POR ESTE BLINDADO
document.getElementById('registro-form-embarazada').addEventListener('submit', function(e) {
    e.preventDefault(); // <--- Aqu√≠ estaba el posible error de dedo antes
    
    try {
        const nombre = document.getElementById('nombre-emb').value.trim();
        const fecha_nacimiento = document.getElementById('fn-emb').value;
        // Blindaje si no existe direcci√≥n
        const campoDir = document.getElementById('dir-emb');
        const direccion = campoDir ? campoDir.value.trim() : "No especificada";
        
        const metodo = document.querySelector('input[name="metodo_calc"]:checked').value;

        // Validaci√≥n b√°sica
        if(!nombre) { alert("El nombre es obligatorio"); return; }

        let nuevoRegistro = {
            id: Date.now().toString(),
            registrado_por: MI_USUARIO,
            nombre,
            fecha_nacimiento,
            direccion: direccion,
            metodo,
            vacunas: {
                influenza: document.getElementById('vacuna-influenza').value,
                dtpa: document.getElementById('vacuna-dtpa').value,
                dtadulto: document.getElementById('vacuna-dtadulto').value,
                vrs: document.getElementById('vacuna-vrs').value
            },
            notas: []
        };

        if (metodo === 'FUR') {
            const fur = document.getElementById('fur').value;
            if (!fur) { alert('La FUR es obligatoria.'); return; }
            nuevoRegistro.fur = fur;
        } else {
            const fus_date = document.getElementById('fus_date').value;
            if (!fus_date) { alert('La fecha FUS es obligatoria.'); return; }
            const eg_w = parseInt(document.getElementById('egus_weeks').value) || 0;
            const eg_d = parseInt(document.getElementById('egus_days').value) || 0;
            
            nuevoRegistro.fur = calcularFURDesdeUS(crearFechaLocal(fus_date), eg_w, eg_d);
            nuevoRegistro.fus_date = fus_date;
            nuevoRegistro.egus_weeks = eg_w;
            nuevoRegistro.egus_days = eg_d;
        }

        embarazadas.push(nuevoRegistro);
        guardarDatos('embarazadas');
        
        // --- LIMPIEZA TOTAL PARA EVITAR BLOQUEO ---
        this.reset(); 
        document.getElementById('nombre-emb').value = ""; // Limpieza forzada
        
        // Reset visual de FUR
        if(document.querySelector('input[name="metodo_calc"][value="FUR"]')) {
             document.querySelector('input[name="metodo_calc"][value="FUR"]').checked = true;
             toggleFurFusFields('FUR');
        }

        alert(`‚úÖ Embarazada ${nombre} registrada con √©xito.`);
        mostrarSeccion('listado-embarazadas');
        
    } catch (error) {
        console.error("Error registro:", error);
        alert("Error al guardar. Verifique los datos.");
    }
});

    
    document.getElementById('registro-form-puerpera').addEventListener('submit', function(e) {
        e.preventDefault();
    const nombre = document.getElementById('nombre-puerp').value.trim();
    const fecha_nacimiento = document.getElementById('fn-puerp').value;
    const direccion = document.getElementById('dir-puerp').value.trim(); // <--- NUEVO
    const fp = document.getElementById('fp').value;

    if (nombre && fp) {
        puerperas.push({
            id: Date.now().toString(),
            registrado_por: MI_USUARIO,
            nombre,
            fecha_nacimiento,
            direccion: direccion, // <--- NUEVO
            fp,
            notas: []
        });
            guardarDatos('puerperas');
            this.reset();
            alert(`‚úÖ Pu√©rpera ${nombre} registrada.`);
            mostrarSeccion('listado-puerperas');
        } else {
            alert('El nombre y la Fecha de Parto (FP) son obligatorios.');
        }
    });

    // --- INICIALIZACI√ìN ---
       // --- INICIALIZACI√ìN SEGURA ---
    document.addEventListener('DOMContentLoaded', () => {
        actualizarSelectorAnios();
        document.querySelectorAll('.buscador-input').forEach(input => {
        input.value = '';
    });
        // 1. Intentamos cargar el usuario (Si falla, no detiene el resto)
        try {
            actualizarDisplayUsuario();
        } catch (e) {
            console.error("Error al cargar usuario:", e);
        }

        // 2. ACTIVACI√ìN DEL MEN√ö DE INICIO (Prioridad m√°xima)
        try {
            mostrarSeccion('inicio');
        } catch (e) {
            console.error("Error al mostrar inicio:", e);
            // Plan B: Forzar visibilidad si la funci√≥n fall√≥
            document.getElementById('inicio').classList.add('active');
        }

        // 3. Procesos secundarios (limpieza autom√°tica y configuraci√≥n de campos)
        // Los envolvemos para que no bloqueen el inicio
        setTimeout(() => {
            verificarAutoArchivo(); 
            
            if (document.querySelector('input[name="metodo_calc"]')) {
                toggleFurFusFields('FUR');
            }
            
            // Verificaci√≥n final del nombre por si se qued√≥ en "Cargando"
            const txtNombre = document.getElementById('display-nombre-recurso');
            if (txtNombre && (txtNombre.innerText === "Cargando..." || txtNombre.innerText === "")) {
                txtNombre.innerText = localStorage.getItem('MI_NOMBRE_RECURSO') || "USUARIO";
            }
        }, 300); 

        /*
         * Informaci√≥n: Se recalcular√° autom√°ticamente al hacer clic en cada paciente.
        */
    });


   /* =============================================================
   BLOQUE FINALIZAR EMBARAZO (V5 - ESTABLE PARA APK)
   Copia y pega esto al final de tu script, reemplazando lo anterior.
   ============================================================= */
let indexTempParto = null; 

// 1. ABRIR EL MODAL 
function finalizarEmbarazo(index) {
    // Protecci√≥n b√°sica
    if (typeof embarazadas === 'undefined' || !embarazadas[index]) {
        console.error("Error: √çndice no v√°lido");
        return;
    }

    indexTempParto = index;
    const paciente = embarazadas[index];

    // REFERENCIAS A ELEMENTOS (Sin recrearlos)
    const modal = document.getElementById('modal-parto');
    const lblNombre = document.getElementById('nombre-paciente-parto');
    const lblInstruccion = document.getElementById('texto-instruccion-dinamico');
    const areaBotones = document.getElementById('selector-tipo-final');
    const areaFecha = document.getElementById('confirmacion-fecha');
    const inputFecha = document.getElementById('fecha-parto-calendario');

    // 1. Poner Datos
    lblNombre.innerText = paciente.nombre; 
    lblInstruccion.innerText = "Seleccione el motivo de finalizaci√≥n:";
    lblInstruccion.style.color = "#555";

    // 2. Reiniciar Vistas (Estado Inicial)
    areaBotones.style.display = 'grid'; 
    areaFecha.style.display = 'none';
    
    // 3. Poner fecha de hoy por defecto (formato YYYY-MM-DD)
    const hoy = new Date();
    const dia = String(hoy.getDate()).padStart(2, '0');
    const mes = String(hoy.getMonth() + 1).padStart(2, '0'); // Enero es 0
    const anio = hoy.getFullYear();
    inputFecha.value = `${anio}-${mes}-${dia}`;

    // 4. Mostrar Ventana
    modal.style.display = 'flex';
}

// 2. ELEGIR PARTO O ABORTO
function seleccionarMotivo(tipo) {
    window.tipoEventoActual = tipo; 
    
    // Ocultamos botones, mostramos calendario
    document.getElementById('selector-tipo-final').style.display = 'none';
    document.getElementById('confirmacion-fecha').style.display = 'block';
    
    // Cambiar texto de instrucci√≥n
    const lblInstruccion = document.getElementById('texto-instruccion-dinamico');
    const texto = tipo === 'parto' ? "CONFIRMAR PARTO" : "CONFIRMAR ABORTO";
    
    lblInstruccion.innerText = `${texto}: Por favor confirme la fecha.`;
    lblInstruccion.style.color = (tipo === 'parto') ? "#4caf50" : "#ff9800";
    lblInstruccion.style.fontWeight = "bold";
}

// 3. GUARDAR
function confirmarParto() {
    if (indexTempParto === null) { cancelarParto(); return; }

    const fp = document.getElementById('fecha-parto-calendario').value;
    if (!fp) { alert("‚ö†Ô∏è Selecciona una fecha v√°lida."); return; }

    const paciente = embarazadas[indexTempParto];
    const tipo = window.tipoEventoActual || 'parto';
    
    // Preparar objeto
    const nuevaPuerpera = {
        id: paciente.id || Date.now().toString(),
        nombre: paciente.nombre,
        fecha_nacimiento: paciente.fecha_nacimiento,
        direccion: paciente.direccion,
        registrado_por: paciente.registrado_por,
        fp: fp,
        tipoEvento: tipo,
        notas: paciente.notas ? [...paciente.notas] : [],
        historial_embarazo: {
            fur: paciente.fur,
            metodo: paciente.metodo,
            vacunas: paciente.vacunas
        }
    };

    // Agregar nota autom√°tica
    const icono = tipo === 'parto' ? "üë∂" : "üè•";
    nuevaPuerpera.notas.unshift({
        fecha: new Date().toLocaleString(),
        texto: `${icono} EVENTO: Finaliz√≥ por ${tipo.toUpperCase()}. Pasa a vigilancia.`,
        etapa: "Sistema"
    });

    // Mover datos
    puerperas.push(nuevaPuerpera);
    embarazadas.splice(indexTempParto, 1);

    guardarDatos('embarazadas');
    guardarDatos('puerperas');

    // Refrescar Listas (IMPORTANTE)
    renderizarListadoEmbarazadas(); 
    document.getElementById('detalle-embarazada').innerHTML = ''; 
    
    cancelarParto(); // Cerrar modal
    
    // Peque√±o delay para que la transici√≥n se vea bien en App
    setTimeout(() => {
        alert(`‚úÖ ${paciente.nombre} movida a Pu√©rperas.`);
        mostrarSeccion('listado-puerperas');
    }, 100);
}

// 4. CANCELAR
function cancelarParto() {
    document.getElementById('modal-parto').style.display = 'none';
    indexTempParto = null;
    window.tipoEventoActual = null;
}



// --- FUNCI√ìN: AUTO-ARCHIVO (42 D√≠as) ---
function verificarAutoArchivo() {
    if (!puerperas || puerperas.length === 0) return;
    let movidas = 0;
    const hoy = new Date();
    const hoyZero = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

    for (let i = puerperas.length - 1; i >= 0; i--) {
        const p = puerperas[i];
        if(!p.fp) continue;
        const fp = crearFechaLocal(p.fp);
        const diffTime = hoyZero.getTime() - fp.getTime();
        const dias = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (dias > 42) {
            p.tipo = 'puerpera';
            p.fecha_archivo = obtenerFechaLocalISO();
            if(!p.notas) p.notas = [];
            p.notas.unshift({ fecha: new Date().toLocaleString(), texto: "üì¶ SISTEMA: Puerperio finalizado (>42 d√≠as)." });

            archivadas.push(p);
            puerperas.splice(i, 1);
            movidas++;
        }
    }
    if (movidas > 0) {
        guardarDatos('puerperas');
        guardarDatos('archivadas');
        alert(`‚ÑπÔ∏è MANTENIMIENTO: Se archivaron ${movidas} pu√©rperas por finalizar periodo (>42 d√≠as).`);
    }
}
    // --- L√ìGICA DE ALERTAS (AGREGADO) ---
function calcularAlertas() {
const alertas = [];
// Usamos 'hoyZero' para comparar peras con peras (sin horas, solo fechas)
const hoy = new Date();
const hoyZero = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

// 1. Revisar Embarazadas
if(typeof embarazadas !== 'undefined') {
    embarazadas.forEach((p, index) => {
        // Usamos crearFechaLocal para evitar errores de zona horaria
        if(!p.fur) return;
        const fur = crearFechaLocal(p.fur);

        const diffTime = hoyZero.getTime() - fur.getTime();
        const diasTotales = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        const semanas = Math.floor(diasTotales / 7);

        if (semanas === 8) alertas.push({p: p.nombre, m: 'Cumple 8 Semanas de Gestaci√≥n (Dar Seguimiento Mensual)', i: index, tipo: 'embarazada'});
        if (semanas === 12) alertas.push({p: p.nombre, m: 'Cumple 12 Semanas de gestaci√≥n (Dar Seguimiento Mensual)', i: index, tipo: 'embarazada'});
        if (semanas === 16) alertas.push({p: p.nombre, m: 'Cumple 16 semanas de gestaci√≥n (Dar Seguimiento Mensual)', i: index, tipo: 'embarazada'});
        if (semanas === 20) alertas.push({p: p.nombre, m: 'Cumple 20 Semanas de gestaci√≥n (Dar Seguimiento para aplicaci√≥n de vacuna DTPa)', i: index, tipo: 'embarazada'});
        if (semanas === 24) alertas.push({p: p.nombre, m: 'Cumple 24 Semanas de gestaci√≥n (Dar Seguimiento Mensual)', i: index, tipo: 'embarazada'});
        if (semanas === 28) alertas.push({p: p.nombre, m: 'Cumple 28 Semanas de gestaci√≥n (Dar Seguimiento Mensual)', i: index, tipo: 'embarazada'});
        if (semanas === 32) alertas.push({p: p.nombre, m: 'Cumple 32 Semanas de gestaci√≥n (Dar Seguimiento para aplicaci√≥n de vacuna Virus Sincitial Respiratorio (VRS)', i: index, tipo: 'embarazada'});
        if (semanas >= 36 && semanas < 40) alertas.push({p: p.nombre, m: 'Semana ' + semanas + ' (Debe dar seguimiento Semanal hasta Finalizar Embarazo)', i: index, tipo: 'embarazada'});
        if (semanas === 40) alertas.push({p: p.nombre, m: 'Cumple 40 semanas de gestaci√≥n (Dar Seguimiento y Referir Urgente a Hospital para Evaluaci√≥n)', i: index, tipo: 'embarazada'});
    });
}

// 2. Revisar Pu√©rperas
if(typeof puerperas !== 'undefined') {
    puerperas.forEach((p, index) => {
        if(!p.fp) return;
        const fp = crearFechaLocal(p.fp);

        // Calculamos diferencia exacta en d√≠as
        const diffTime = hoyZero.getTime() - fp.getTime();
        const dias = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        // Depuraci√≥n (Opcional: puedes ver esto en la consola del navegador)
        console.log(`Paciente: ${p.nombre}, D√≠as Puerperio: ${dias}`);

        if (dias === 1) alertas.push({p: p.nombre, m: 'Detecci√≥n de Pu√©rpera (Dar seguimiento para detecci√≥n luego del alta hospitalaria)', i: index, tipo: 'puerpera'});
        if (dias === 3) alertas.push({p: p.nombre, m: 'Visita de Seguimiento (3 d√≠as de puerperio) Verificar Signos de alarma de pu√©rpera y reci√©n nacido', i: index, tipo: 'puerpera'});
        if (dias === 7) alertas.push({p: p.nombre, m: 'Visita de Seguimiento (7 d√≠as de puerperio) Verificar Inscripci√≥n Infantil en Unidad de Salud y control de pu√©rpera ', i: index, tipo: 'puerpera'});
        if (dias === 15) alertas.push({p: p.nombre, m: 'visita de Seguimiento (15 d√≠as de puerperio) reforzar educaci√≥n en Lactancia Materna Exclusiva hasta los 6 meses y signos de Alarma', i: index, tipo: 'puerpera'});
        if (dias === 28) alertas.push({p: p.nombre, m: 'Visita de Seguimiento (28 d√≠as de puerperio) √öltimo seguimiento normado para Reci√©n Nacido, seguimiento a pu√©rpera', i: index, tipo: 'puerpera'});
        if (dias === 42) alertas.push({p: p.nombre, m: 'Fin de Puerperio (42 d√≠as)', i: index, tipo: 'puerpera'});
    });
}
return alertas;
}
function renderizarAlertas() {
const lista = calcularAlertas();
const contenedor = document.getElementById('contenedor-alertas');
const contador = document.getElementById('contador-alertas');

// Actualizar bot√≥n
if(contador) contador.innerText = lista.length;

// Llenar panel
if(contenedor) {
    contenedor.innerHTML = '';
    if(lista.length === 0) {
        contenedor.innerHTML = '<p style="text-align:center; color:#777;">‚úÖ No hay alertas pendientes hoy.</p>';
        return;
    }
    lista.forEach(alerta => {
        const div = document.createElement('div');
        div.className = 'alerta-card';
        // Acci√≥n para ver detalle
        const onclickJS = `mostrarSeccion('${alerta.tipo === 'embarazada' ? 'listado-embarazadas' : 'listado-puerperas'}'); mostrarDetalle(${alerta.i}, '${alerta.tipo}');`;

       // AQU√ç EST√Å EL CAMBIO DEL BOT√ìN:
            div.innerHTML = `
                <div style="flex: 1; padding-right: 10px;">
                    <h4 style="margin:0; color:#333;">${alerta.p}</h4>
                    <small style="color:#d32f2f;">${alerta.m}</small>
                </div>
                <button class="btn-alerta-blink" onclick="${onclickJS}">Ver üëÅÔ∏è</button>
            `;
            contenedor.appendChild(div);
        });
    }
}// ==========================================
// CONEXI√ìN FIREBASE DE GOOGLE (BASE DE DATOS)
// ==========================================

async function guardarEnNube() {
    if (!validarAccesoNube()) return; // <-- Solo pedir√° el PIN si no ha sido autorizado hoy
    
    // 1. BLOQUEO DE SEGURIDAD TOTAL
    const bloqueoPersistente = localStorage.getItem('BLOQUEO_SUBIDA') === 'true';
    
    if (MODO_SUPERVISOR || bloqueoPersistente) {
        alert("üö´ ACCI√ìN DENEGADA: Este dispositivo contiene datos de m√∫ltiples usuarios (Global).\n\nPara evitar errores, la subida ha sido desactivada.");
        return;
    }

    // 2. Conteo local de registros
    const totalLocal = (embarazadas ? embarazadas.length : 0) + 
                       (puerperas ? puerperas.length : 0) + 
                       (archivadas ? archivadas.length : 0);

    // ESCUDO: Bloqueo por base vac√≠a
    if (totalLocal === 0) {
        alert("üö´ ACCI√ìN BLOQUEADA: No hay datos en este dispositivo.\n\nSugerencia: Presiona 'Bajar de Nube' para recuperar tu informaci√≥n.");
        return;
    }

    const btn = document.getElementById('btn-nube-guardar');
    if (!navigator.onLine) { alert("‚ö†Ô∏è Sin conexi√≥n a internet."); return; }
    
    btn.innerText = '‚è≥ Verificando integridad...';

    try {
        const nodoUsuario = MI_USUARIO.trim().replace(/[.#$\[\]]/g, "_");
        const snapshot = await database.ref('respaldos/' + nodoUsuario).once('value');
        const datosNube = snapshot.val();

        if (datosNube) {
            const totalNube = (datosNube.meta ? datosNube.meta.total : 0);
            const versionNube = (datosNube.meta ? datosNube.meta.timestamp : 0);
            const versionAlDescargar = localStorage.getItem('ULTIMA_VERSION_DESCARGADA');

            // --- ESCUDO 1: Verificaci√≥n por cantidad (Protecci√≥n contra borrado masivo) ---
            if (totalLocal < totalNube) {
                const dif = totalNube - totalLocal;
                alert(`‚ö†Ô∏è ¬°ALERTA DE SEGURIDAD!\n\nEn la NUBE hay ${totalNube} registros y aqu√≠ solo tienes ${totalLocal}.\n\nüö® Si subes ahora, BORRAR√ÅS ${dif} expedientes.\n\n‚úÖ SUGERENCIA: Presiona 'BAJAR DE NUBE' primero.`);
                btn.innerText = '‚òÅÔ∏è Guardar en Nube';
                return;
            }

            // --- ESCUDO 2: DETECCI√ìN POR VERSI√ìN (Conflicto con otros equipos) ---
            // Si la versi√≥n en la nube cambi√≥ respecto a la que bajamos, alguien m√°s edit√≥.
            if (versionAlDescargar && versionNube != versionAlDescargar) {
                const confirmCambio = confirm("üîî ¬°ALERTA DE CONFLICTO!\n\nOtro dispositivo subi√≥ cambios que t√∫ NO tienes en este tel√©fono.\n\n¬øDeseas sobreescribir de todos modos? (Esto borrar√° lo que subi√≥ el otro equipo)");
                
                if (!confirmCambio) {
                    btn.innerText = '‚òÅÔ∏è Guardar en Nube';
                    return; 
                }
            }
        }

        // MENSAJE DE CONFIRMACI√ìN FINAL
        const mensajeFinal = `‚ö†Ô∏è ¬øEST√ÅS SEGURO DE SUBIR DATOS?\n\nSe enviar√°n ${totalLocal} registros a la nube para el usuario: ${MI_USUARIO}.\n\n¬øDeseas proceder?`;
        
        if (!confirm(mensajeFinal)) {
            btn.innerText = '‚òÅÔ∏è Guardar en Nube';
            return;
        }

        // 3. PROCESO DE SUBIDA
        btn.innerText = '‚è≥ Sincronizando...';
        const datosASincronizar = {
            meta: {
                usuario: MI_USUARIO,
                ultimaActualizacion: new Date().toLocaleString(),
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                total: totalLocal
            },
            embarazadas, puerperas, archivadas
        };

        // Ejecutar el guardado en Firebase
        await database.ref('respaldos/' + nodoUsuario).set(datosASincronizar);

        // --- ACTUALIZACI√ìN DEL TOKEN LOCAL ---
        // Recuperamos el nuevo timestamp que el servidor gener√≥ para que 
        // nuestro pr√≥ximo guardado sea "pareja" con la nube.
        const nuevoSnapshot = await database.ref('respaldos/' + nodoUsuario + '/meta/timestamp').once('value');
        const nuevoTimestamp = nuevoSnapshot.val();
        if (nuevoTimestamp) {
            localStorage.setItem('ULTIMA_VERSION_DESCARGADA', nuevoTimestamp);
        }

        alert(`‚úÖ Sincronizaci√≥n exitosa. Se respaldaron ${totalLocal} registros.`);
        btn.innerText = '‚òÅÔ∏è Guardar en Nube';

    } catch (error) {
        console.error("Error en GuardarEnNube:", error);
        alert("‚ùå Error: " + error.message);
        btn.innerText = '‚òÅÔ∏è Guardar en Nube';
    }
}



async function cargarDeNube(esDescargaTotal = false) {
    if (!validarAccesoNube()) return; // <-- Lo mismo aqu√≠
    const btnId = esDescargaTotal ? 'btn-sup-cargar' : 'btn-nube-cargar';
    const btn = document.getElementById(btnId);
    
    if (!navigator.onLine) {
        alert("‚ö†Ô∏è Sin conexi√≥n a internet para descargar.");
        return;
    }

    if(btn) {
        btn.innerText = '‚è≥ Conectando...';
        btn.disabled = true;
    }

    const nodoUsuario = MI_USUARIO.trim().replace(/[.#$\[\]]/g, "_");
    const ruta = esDescargaTotal ? 'respaldos' : 'respaldos/' + nodoUsuario;

    try {
        // 1. PRIMERA CONSULTA: Vamos a ver qu√© hay en la nube antes de bajarlo
        const snapshot = await database.ref(ruta).once('value');
        const datosNube = snapshot.val();

        if (!datosNube) {
            alert("No se encontraron datos en la nube para el usuario: " + MI_USUARIO);
            if(btn) btn.innerText = esDescargaTotal ? 'üì• DESCARGAR TODO' : 'üì• Bajar de Nube';
            if(btn) btn.disabled = false;
            return;
        }

        // 2. CONTEO DE REGISTROS EN LA NUBE
        let totalNube = 0;
        if (esDescargaTotal) {
            // Si es supervisor, sumamos los datos de todos los usuarios
            Object.keys(datosNube).forEach(key => {
                const u = datosNube[key];
                totalNube += (u.embarazadas ? u.embarazadas.length : 0) + 
                             (u.puerperas ? u.puerperas.length : 0) + 
                             (u.archivadas ? u.archivadas.length : 0);
            });
        } else {
            // Si es promotor, sumamos sus propios datos
            totalNube = (datosNube.embarazadas ? datosNube.embarazadas.length : 0) + 
                        (datosNube.puerperas ? datosNube.puerperas.length : 0) + 
                        (datosNube.archivadas ? datosNube.archivadas.length : 0);
        }

        // 3. MENSAJE DE ADVERTENCIA Y CONFIRMACI√ìN (LO QUE PEDISTE)
        const mensajeConfirmacion = esDescargaTotal 
            ? `üëÆ MODO SUPERVISOR:\n\nSe han encontrado ${totalNube} registros globales en la nube.\n\n¬øDeseas bajarlos todos? Esto bloquear√° la subida en este equipo.`
            : `‚ö†Ô∏è ADVERTENCIA DE DESCARGA:\n\nEn la nube hay ${totalNube} registros guardados.\n\nAl bajar esta informaci√≥n, se BORRAR√Å lo que tienes actualmente en este tel√©fono y se reemplazar√° por lo de la nube.\n\n¬øEst√°s seguro de bajar los ${totalNube} registros?`;

        if (!confirm(mensajeConfirmacion)) {
            if(btn) {
                btn.innerText = esDescargaTotal ? 'üì• DESCARGAR TODO' : 'üì• Bajar de Nube';
                btn.disabled = false;
            }
            return;
        }

        // 4. PROCESO DE CARGA (TU L√ìGICA ORIGINAL)
        if (esDescargaTotal) {
            localStorage.setItem('BLOQUEO_SUBIDA', 'true'); 
            let totalEmb = [], totalPue = [], totalArc = [];

            Object.keys(datosNube).forEach(key => {
                const dataUsuario = datosNube[key];
                if (dataUsuario.embarazadas) totalEmb = totalEmb.concat(dataUsuario.embarazadas);
                if (dataUsuario.puerperas) totalPue = totalPue.concat(dataUsuario.puerperas);
                if (dataUsuario.archivadas) totalArc = totalArc.concat(dataUsuario.archivadas);
            });

            embarazadas = totalEmb;
            puerperas = totalPue;
            archivadas = totalArc;
        } else {
            embarazadas = datosNube.embarazadas || [];
            puerperas = datosNube.puerperas || [];
            archivadas = datosNube.archivadas || [];
             // AGREGA ESTO AQU√ç:
        if (datosNube.meta && datosNube.meta.timestamp) {
        localStorage.setItem('ULTIMA_VERSION_DESCARGADA', datosNube.meta.timestamp);
           }
        }

        // Guardar en memoria local
        localStorage.setItem('embarazadas', JSON.stringify(embarazadas));
        localStorage.setItem('puerperas', JSON.stringify(puerperas));
        localStorage.setItem('archivadas', JSON.stringify(archivadas));

        alert(`‚úÖ √âXITO: Se han descargado ${totalNube} registros correctamente.`);
        
        if(esDescargaTotal) {
            iniciarPanelSupervisor();
        } else {
            location.reload(); 
        }

    } catch (error) {
        console.error("Error al descargar:", error);
        alert("‚ùå Error: " + error.message);
    } finally {
        if(btn) {
            btn.innerText = esDescargaTotal ? 'üì• DESCARGAR TODO' : 'üì• Bajar de Nube';
            btn.disabled = false;
        }
    }
}


/* ======================================================
   >>> BLOQUE 5: L√ìGICA DEL SUPERVISOR (NUEVO) <<<
   ====================================================== */

// 1. Modificar Renderizado de Listas (Reemplaza tus funciones actuales con estas versiones mejoradas)
function renderizarListadoEmbarazadas() {
    const ul = document.getElementById('lista-nombres-embarazadas');
    ul.innerHTML = '';

    let lista = embarazadas;
    // Filtro M√°gico del Supervisor
    if(MODO_SUPERVISOR && FILTRO_USUARIO_ACTUAL) {
        lista = embarazadas.filter(p => (p.registrado_por || "Desconocido") === FILTRO_USUARIO_ACTUAL);
    }

    if (lista.length === 0) { ul.innerHTML = '<li>No hay registros.</li>'; return; }

    lista.forEach((p, index) => {
        // Encontrar √≠ndice real para que al hacer click abra el correcto
        const realIndex = embarazadas.indexOf(p);
        const li = document.createElement('li');
        li.textContent = p.nombre;
        li.onclick = () => mostrarDetalle(realIndex, 'embarazada');
        ul.appendChild(li);
    });
}

function renderizarListadoPuerperas() {
    const ul = document.getElementById('lista-nombres-puerperas');
    ul.innerHTML = '';

    let lista = puerperas;
    if(MODO_SUPERVISOR && FILTRO_USUARIO_ACTUAL) {
        lista = puerperas.filter(p => (p.registrado_por || "Desconocido") === FILTRO_USUARIO_ACTUAL);
    }

    if (lista.length === 0) { ul.innerHTML = '<li>No hay registros.</li>'; return; }

    lista.forEach((p, index) => {
        const realIndex = puerperas.indexOf(p);
        const li = document.createElement('li');
        li.textContent = p.nombre;
        li.onclick = () => mostrarDetalle(realIndex, 'puerpera');
        ul.appendChild(li);
    });
}

function renderizarListadoArchivadas() {
    const ul = document.getElementById('lista-nombres-archivadas');
    
    // Capturamos los valores de los filtros (Aseg√∫rate de tener estos ID en tu HTML)
    const filtroMes = document.getElementById('filtro-mes-arch') ? document.getElementById('filtro-mes-arch').value : 'todos';
    const filtroAnio = document.getElementById('filtro-anio-arch') ? document.getElementById('filtro-anio-arch').value : 'todos';
    
    ul.innerHTML = '';

    // 1. Filtro inicial: Por Supervisor (tu l√≥gica original)
    let lista = archivadas;
    if(MODO_SUPERVISOR && FILTRO_USUARIO_ACTUAL) {
        lista = archivadas.filter(p => (p.registrado_por || "Desconocido") === FILTRO_USUARIO_ACTUAL);
    }

    // 2. Filtro secundario: Por Mes y A√±o (L√≥gica nueva)
    lista = lista.filter(p => {
        if (!p.fecha_archivo) return true; // Si no tiene fecha, lo mostramos por defecto
        
        const partes = p.fecha_archivo.split('-'); // Asume formato AAAA-MM-DD
        const anioP = partes[0];
        const mesP = partes[1];

        const cumpleMes = (filtroMes === 'todos' || filtroMes === mesP);
        const cumpleAnio = (filtroAnio === 'todos' || filtroAnio === anioP);

        return cumpleMes && cumpleAnio;
    });

    if (lista.length === 0) { 
        ul.innerHTML = '<li>No hay registros que coincidan con el filtro.</li>'; 
        return; 
    }

    // 3. Renderizado final
    lista.forEach((p) => {
        const realIndex = archivadas.indexOf(p);
        const li = document.createElement('li');
        li.textContent = `[${p.tipo === 'embarazada' ? 'E' : 'P'}] ${p.nombre}`;
        li.onclick = () => mostrarDetalleArchivada(realIndex);
        ul.appendChild(li);
    });
}

function ocultarBotonesEdicion() {
    // Oculta todos los botones de acci√≥n, formularios de notas y paneles de control
    document.querySelectorAll('.btn-pro, .btn-guardar, form textarea').forEach(el => {
        // Excepci√≥n: Permitir botones de "Volver" y "PDF"
        if(!el.innerText.includes("Volver") && !el.innerText.includes("PDF")) {
            el.style.display = 'none';
        }
    });
    // Ocultar formularios de notas
    document.querySelectorAll('form').forEach(f => f.style.display = 'none');
}

// --- FUNCIONES DE LOGIN CORREGIDAS ---

function abrirLoginSupervisor() {
    const modal = document.getElementById('modal-login-supervisor');
    const input = document.getElementById('input-pass-supervisor');
    
    if(modal) {
        // Usamos 'flex' para activar el centrado perfecto del CSS
        modal.style.display = 'flex'; 
        
        if(input) {
            input.value = ''; // Limpiar campo
            setTimeout(() => input.focus(), 100); // Enfocar autom√°ticamente
        }
    }
}

function cerrarLoginSupervisor() {
    const modal = document.getElementById('modal-login-supervisor');
    if(modal) modal.style.display = 'none';
}

function verificarSupervisor() {
    const input = document.getElementById('input-pass-supervisor');
    const pass = input.value;

    // TU CONTRASE√ëA
    const PASS_CORRECTA = "admin123"; 

    if (pass === PASS_CORRECTA) {
        cerrarLoginSupervisor();
        // Peque√±a espera para que la transici√≥n se vea bien
        setTimeout(() => {
            iniciarPanelSupervisor();
        }, 200);
    } else {
        // Efecto de error visual
        input.style.borderColor = "red";
        input.style.backgroundColor = "#ffebee";
        alert("‚õî Contrase√±a Incorrecta");
        
        setTimeout(() => {
            input.style.borderColor = "#ddd";
            input.style.backgroundColor = "white";
            input.focus();
        }, 1000);
    }
}


function iniciarPanelSupervisor() {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('panel-supervisor').classList.add('active');

    // Contadores
    document.getElementById('sup-total-emb').innerText = embarazadas.length;
    document.getElementById('sup-total-pue').innerText = puerperas.length;

    // Lista de Recursos
    const todos = [...embarazadas, ...puerperas, ...archivadas];
    const usuarios = [...new Set(todos.map(r => r.registrado_por || "Desconocido"))];

    const div = document.getElementById('lista-recursos-supervisor');
    div.innerHTML = '';

    // Opci√≥n Ver Todos
    div.innerHTML += `<button onclick="entrarComoRecurso(null)" class="dash-card" style="width:100%; margin-bottom:10px;">üëÅÔ∏è VER TODO (Mapa Completo)</button>`;

    usuarios.forEach(u => {
        let count = todos.filter(r => (r.registrado_por || "Desconocido") === u).length;
        div.innerHTML += `
            <div class="dash-card" onclick="entrarComoRecurso('${u}')" style="margin-bottom:10px; border-left:5px solid #00796b;">
                <h4>üë§ ${u}</h4>
                <small>${count} expedientes</small>
            </div>
        `;
    });
}

function entrarComoRecurso(nombre) {
    MODO_SUPERVISOR = true;
    FILTRO_USUARIO_ACTUAL = nombre;
    document.getElementById('panel-supervisor').classList.remove('active');
    mostrarSeccion('inicio');
    document.getElementById('barra-aviso-supervisor').style.display = 'block';
    // Ocultar botones de crear
    document.querySelectorAll('.btn-nuevo-registro').forEach(b => b.style.display = 'none');
}

function regresarAlPanelSupervisor() {
    iniciarPanelSupervisor();
    document.getElementById('barra-aviso-supervisor').style.display = 'none';
}

function salirSupervisor() {
    MODO_SUPERVISOR = false;
    FILTRO_USUARIO_ACTUAL = null;
    mostrarSeccion('inicio');
    document.querySelectorAll('.btn-nuevo-registro').forEach(b => b.style.display = 'block');
}

function generarReporteGlobal() {
    // Verificar si la librer√≠a carg√≥
    if (typeof XLSX === 'undefined') {
        alert("‚ùå Error: La librer√≠a de Excel no ha cargado. Revisa tu conexi√≥n.");
        return;
    }

    alert("‚è≥ Creando Excel limpio...");

    setTimeout(() => {
        try {
            let datosExcel = [
                ["TIPO", "NOMBRE", "EDAD", "DIRECCION", "FUR", "FPP / PARTO", "REGISTRADO POR", "FECHA REGISTRO", "NOTAS"]
            ];

            // --- FUNCIONES DE LIMPIEZA (AQU√ç EST√Å EL ARREGLO) ---

            // 1. Funci√≥n para quitar el T06:00:00...
            const limpiarFecha = (fechaRaw) => {
                if (!fechaRaw) return "";
                // Si es un objeto fecha, lo convertimos
                let fechaStr = String(fechaRaw);

                // Si tiene la "T" de tiempo, la cortamos
                if (fechaStr.includes("T")) {
                    fechaStr = fechaStr.split("T")[0]; // Nos quedamos solo con lo de antes de la T
                }

                // Intentamos darle formato bonito DD/MM/AAAA usando tus funciones
                try {
                    return formatDate(crearFechaLocal(fechaStr));
                } catch(e) {
                    return fechaStr; // Si falla, devolvemos la fecha limpia (AAAA-MM-DD)
                }
            };

            const getEdad = (fn) => fn ? calcularEdad(crearFechaLocal(fn)) + ' a√±os' : '-';

            const getFPP = (furStr) => {
                if(!furStr) return '';
                try { return formatDate(calcularFPP(crearFechaLocal(furStr))); } catch(e) { return ''; }
            };

            const getNotas = (notas) => {
                if (!notas || !Array.isArray(notas) || notas.length === 0) return "";
                return notas.map(n => `[${limpiarFecha(n.fecha)}] ${n.texto}`).join(" || ");
            };

            // 2. Procesamos las listas
            const agregarAExcel = (lista, etiqueta) => {
                if (!lista) return;
                lista.forEach(p => {
                    // Calculamos valores
                    let edad = getEdad(p.fecha_nacimiento);
                    let direccion = p.direccion || "No especificada";
                    let datoFur = '', datoFpp = '';

                    // L√≥gica espec√≠fica
                    if(etiqueta === 'EMBARAZADA') {
                        // --- USAMOS LA NUEVA FUNCI√ìN AQU√ç ---
                        datoFur = limpiarFecha(p.fur);
                        if(p.fur) datoFpp = getFPP(p.fur);
                    } else {
                        datoFpp = p.fp ? `Parto: ${limpiarFecha(p.fp)}` : '';
                        if(p.historial_embarazo && p.historial_embarazo.fur) {
                            datoFur = limpiarFecha(p.historial_embarazo.fur);
                        }
                    }

                    let autor = p.registrado_por || "Desconocido";
                    // Tambi√©n limpiamos la fecha de registro
                    let fechaReg = p.id ? new Date(parseInt(p.id)).toLocaleDateString() : '';
                    let notasTexto = getNotas(p.notas);

                    datosExcel.push([
                        etiqueta,
                        p.nombre,
                        edad,
                        direccion,
                        datoFur,  // Ahora va limpia
                        datoFpp,  // Ahora va limpia
                        autor,
                        fechaReg,
                        notasTexto
                    ]);
                });
            };

            agregarAExcel(embarazadas, "EMBARAZADA");
            agregarAExcel(puerperas, "PUERPERA");
            agregarAExcel(archivadas, "ARCHIVADA");

            // 3. Generar archivo
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(datosExcel);

            const wscols = [
                {wch: 12}, {wch: 30}, {wch: 10}, {wch: 25},
                {wch: 15}, {wch: 20}, {wch: 20}, {wch: 15}, {wch: 50}
            ];
            ws['!cols'] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, "Reporte Global");
            XLSX.writeFile(wb, `Reporte_Oficial_${new Date().getTime()}.xlsx`);

        } catch (error) {
            console.error(error);
            alert("‚ùå Error: " + error.message);
        }
    }, 500);
}


// ==========================================
// BARRA DE USUARIO (VERSI√ìN INSTANT√ÅNEA)
// ==========================================

function actualizarDisplayUsuario() {
    try {
        const etiqueta = document.getElementById('display-nombre-recurso');
        if (!etiqueta) return; // Si no existe el elemento, no hacemos nada

        let nombre = localStorage.getItem('MI_NOMBRE_RECURSO');

        // Si el nombre est√° vac√≠o o es un error, ponemos uno gen√©rico
        if (!nombre || nombre === "SIN_NOMBRE" || nombre === "" || nombre === "null") {
            nombre = "PERSONAL DE SALUD";
        }

        etiqueta.innerText = nombre;
    } catch (error) {
        console.error("Error cr√≠tico al cargar nombre, continuando inicio...", error);
        // Si falla, nos aseguramos de que el texto no diga "Cargando..."
        const etiquetaError = document.getElementById('display-nombre-recurso');
        if(etiquetaError) etiquetaError.innerText = "USUARIO";
    }
}


function cambiarNombreUsuario() {
    // 1. Capturamos el nombre VIEJO antes de que cambie
    let nombreAnterior = localStorage.getItem('MI_NOMBRE_RECURSO');

    let nuevo = prompt("Escribe tu nombre de trabajador:", nombreAnterior || "");

    if (nuevo && nuevo.trim().length > 0) {
        let nombreFinal = nuevo.toUpperCase().trim();

        // Si el nombre es igual al que ya ten√≠as, no hacemos nada
        if(nombreFinal === nombreAnterior) return;

        // 2. Guardamos el NUEVO nombre
        localStorage.setItem('MI_NOMBRE_RECURSO', nombreFinal);
        if(typeof MI_USUARIO !== 'undefined') MI_USUARIO = nombreFinal;

        // 3. --- MIGRACI√ìN DE DATOS (LA MAGIA) ---
        // Recorremos todas las listas y buscamos los registros que ten√≠an tu nombre viejo
        // o que no ten√≠an nombre, y les ponemos el nuevo.

        let cambiados = 0;

        const actualizarEtiqueta = (lista) => {
            lista.forEach(paciente => {
                // Si la paciente fue registrada por mi YO del pasado...
                if (paciente.registrado_por === nombreAnterior || !paciente.registrado_por || paciente.registrado_por === "SIN_NOMBRE") {
                    paciente.registrado_por = nombreFinal; // ¬°Actualizamos la firma!
                    cambiados++;
                }
            });
        };

        actualizarEtiqueta(embarazadas);
        actualizarEtiqueta(puerperas);
        actualizarEtiqueta(archivadas);

        // 4. Guardamos los cambios en la memoria del tel√©fono
        guardarDatos('embarazadas');
        guardarDatos('puerperas');
        guardarDatos('archivadas');

        // 5. Actualizamos visualmente
        const etiqueta = document.getElementById('display-nombre-recurso');
        if(etiqueta) {
            etiqueta.innerText = nombreFinal;
            etiqueta.style.color = "#a7ffeb";
            setTimeout(() => etiqueta.style.color = "#4db6ac", 500);
        }

        // 6. Aviso inteligente
        setTimeout(() => {
            alert(`‚úÖ Nombre actualizado a: ${nombreFinal}.\n\nüîÑ Se han actualizado ${cambiados} expedientes antiguos para que aparezcan bajo tu nuevo nombre.`);
        }, 100);
    }
}
// ==========================================
// FUNCI√ìN DE BORRADO DE F√ÅBRICA (CORREGIDA)
// ==========================================
function borrarTodoDeFabrica() {
    // 1. Primera pregunta de seguridad
    if(!confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO?\n\nEsto borrar√° TODOS los pacientes, configuraciones y tu nombre de usuario de ESTE dispositivo.")) return;

    // 2. Segunda pregunta de seguridad
    if(!confirm("‚ò¢Ô∏è CONFIRMACI√ìN FINAL:\nEsta acci√≥n no se puede deshacer.\n\n¬øBorrar todo permanentemente?")) return;

    // 3. Borrado total
    localStorage.clear();

    // 4. Reinicio
    alert("‚úÖ La aplicaci√≥n se ha reiniciado de f√°brica. Todos los datos han sido borrados.");
    location.reload();
}


function generarReporteHTML() {
    // 1. FORZAR SCROLL AL PRINCIPIO
    window.scrollTo(0, 0);
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;

    mostrarSeccion('seccion-reporte-interno');
    
    const contenedorReporte = document.getElementById('seccion-reporte-interno');
    const tabla = document.getElementById('cuerpo-reporte');
    const cabeceraTabla = document.querySelector('#seccion-reporte-interno thead tr');
    
    const ahora = new Date();
    const fechaStr = ahora.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const horaStr = ahora.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

    // 2. LIMPIEZA DE ENCABEZADOS PREVIOS
    const previoHeader = document.getElementById('stats-header-reporte');
    if (previoHeader) previoHeader.remove();

    // 3. CREACI√ìN DEL ENCABEZADO (Bot√≥n arriba + T√≠tulo + Contadores)
    const statsHeader = document.createElement('div');
    statsHeader.id = 'stats-header-reporte';
    statsHeader.style.padding = '10px';
    
    statsHeader.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <button onclick="mostrarSeccion('inicio'); window.scrollTo(0,0);" style="
                background: linear-gradient(135deg, #ff5722, #f44336); 
                color: white; border: none; padding: 10px 20px; border-radius: 8px; 
                font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            ">
                ‚¨Ö VOLVER
            </button>
            <div style="text-align: right; color: black; font-size: 0.85rem; font-weight: bold;">
                ${fechaStr} | ${horaStr}
            </div>
        </div>

        <div style="text-align: center; margin-bottom: 15px; border-bottom: 3px solid black; padding-bottom: 5px;">
            <h2 style="margin:0; color:black; font-size: 1.2rem; font-weight: bold;">REPORTE GENERAL DE VIGILANCIA</h2>
        </div>

        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
            <div style="flex: 1; background: #673ab7; color: white; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                <div style="font-size: 1.4rem; font-weight: bold;">${embarazadas.length}</div>
                <div style="font-size: 0.65rem; font-weight: bold; text-transform: uppercase;">Embarazadas</div>
            </div>
            <div style="flex: 1; background: #e91e63; color: white; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                <div style="font-size: 1.4rem; font-weight: bold;">${puerperas.length}</div>
                <div style="font-size: 0.65rem; font-weight: bold; text-transform: uppercase;">Pu√©rperas</div>
            </div>
            <div style="flex: 1; background: #555; color: white; padding: 12px; border-radius: 8px; text-align: center; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">
                <div style="font-size: 1.4rem; font-weight: bold;">${archivadas.length}</div>
                <div style="font-size: 0.65rem; font-weight: bold; text-transform: uppercase;">Archivadas</div>
            </div>
        </div>
    `;
    contenedorReporte.insertBefore(statsHeader, contenedorReporte.firstChild);

    // 4. ACTUALIZAR CABECERA DE TABLA (Incluye EDAD)
    if (cabeceraTabla) {
        cabeceraTabla.innerHTML = `
            <th style="padding: 10px; border: 1.5px solid black; background: #eee; color: black; font-size: 0.8rem;">Tipo</th>
            <th style="padding: 10px; border: 1.5px solid black; background: #eee; color: black; font-size: 0.8rem;">Nombre</th>
            <th style="padding: 10px; border: 1.5px solid black; background: #eee; color: black; font-size: 0.8rem;">Edad</th>
            <th style="padding: 10px; border: 1.5px solid black; background: #eee; color: black; font-size: 0.8rem;">Direcci√≥n</th>
            <th style="padding: 10px; border: 1.5px solid black; background: #eee; color: black; font-size: 0.8rem;">FUR/Parto</th>
            <th style="padding: 10px; border: 1.5px solid black; background: #eee; color: black; font-size: 0.8rem;">FPP</th>
            <th style="padding: 10px; border: 1.5px solid black; background: #eee; color: black; font-size: 0.8rem;">Recurso</th>
        `;
    }

    // 5. GENERAR FILAS (Bordes negros y datos completos)
    tabla.innerHTML = ""; 
    const todas = [
        ...embarazadas.map(p => ({...p, tipo: 'EMB'})),
        ...puerperas.map(p => ({...p, tipo: 'PUE'})),
        ...archivadas.map(p => ({...p, tipo: 'ARC'}))
    ];

    todas.forEach(p => {
        const fila = document.createElement('tr');
        
        // --- CORRECCI√ìN AQU√ç: Se cambi√≥ " a√±" por " a√±os" ---
        let edad = p.fecha_nacimiento ? calcularEdad(crearFechaLocal(p.fecha_nacimiento)) + " a√±os" : "-";
        
        let fpp = "-";
        if(p.tipo === 'EMB' && p.fur) {
            try { fpp = formatDate(calcularFPP(crearFechaLocal(p.fur))); } catch(e) { fpp = "Err"; }
        }

        const colorEtiqueta = p.tipo === 'EMB' ? '#673ab7' : (p.tipo === 'PUE' ? '#e91e63' : '#555');

        fila.innerHTML = `
            <td style="padding: 12px 5px; border: 1.5px solid black; text-align: center; background: white;">
                <span style="background:${colorEtiqueta}; color:white; padding:2px 5px; border-radius:4px; font-size:0.6rem; font-weight:bold;">${p.tipo}</span>
            </td>
            <td style="padding: 12px 8px; border: 1.5px solid black; font-weight:bold; color:black; background: white; font-size:0.8rem;">${p.nombre}</td>
            <td style="padding: 12px 8px; border: 1.5px solid black; text-align: center; color:black; background: white; font-size:0.8rem;">${edad}</td>
            <td style="padding: 12px 8px; border: 1.5px solid black; color:black; background: white; font-size: 0.75rem;">${p.direccion || '-'}</td>
            <td style="padding: 12px 8px; border: 1.5px solid black; text-align: center; color:black; background: white; font-size: 0.75rem;">${p.fur || p.fp || '-'}</td>
            <td style="padding: 12px 8px; border: 1.5px solid black; text-align: center; font-weight: bold; color:black; background: white; font-size: 0.75rem;">${fpp}</td>
            <td style="padding: 12px 8px; border: 1.5px solid black; color:black; background: white; font-size: 0.65rem;">${p.registrado_por || '??'}</td>
        `;
        tabla.appendChild(fila);
    });

    // Ajuste de bordes negros para la tabla completa
    const tablaElement = document.querySelector('#seccion-reporte-interno table');
    if(tablaElement) {
        tablaElement.style.borderCollapse = "collapse";
        tablaElement.style.border = "2px solid black";
        tablaElement.style.width = "100%";
    }
}

function chequearBloqueoVisual() {
    if (localStorage.getItem('BLOQUEO_SUBIDA') === 'true') {
        const btn = document.getElementById('btn-nube-guardar');
        if (btn) {
            btn.style.opacity = "0.5";
            btn.style.pointerEvents = "none"; // Desactiva el clic
            btn.innerText = "üîí Subida Bloqueada (Modo Global)";
        }
    }
}
// Ejecutar al cargar la p√°gina
chequearBloqueoVisual();

// Funciones para abrir y cerrar el panel de configuraci√≥n
function abrirConfiguracionNueva() {
    document.getElementById('modalConfig').style.display = 'flex';
}

function cerrarConfiguracionNueva() {
    document.getElementById('modalConfig').style.display = 'none';
}

// Nueva funci√≥n de refresco r√°pido
function refrescarApp() {
    if (confirm("üîÑ ¬øDesea recargar la aplicaci√≥n?\n\nEsto actualizar√° la interfaz y los datos del sistema.")) {
        window.location.reload();
    }
}

// Cerrar el modal si el usuario toca fuera del cuadro blanco
window.onclick = function(event) {
    const modal = document.getElementById('modalConfig');
    if (event.target == modal) {
        cerrarConfiguracionNueva();
    }
}

function validarAccesoNube() {
    // 1. Revisar si ya se desbloque√≥ en esta sesi√≥n
    if (localStorage.getItem('NUBE_AUTORIZADA') === 'true') {
        return true;
    }

    // 2. Si no, pedir el PIN
    const intento = prompt("üîê Dispositivo no autorizado.\nIntroduzca el PIN de seguridad para habilitar funciones de nube:");
    
    if (intento === PIN_SEGURIDAD) {
        localStorage.setItem('NUBE_AUTORIZADA', 'true'); // Guardar autorizaci√≥n temporal
        alert("‚úÖ Acceso concedido. Las funciones de nube estar√°n activas durante esta sesi√≥n.");
        return true;
    } else {
        alert("‚ùå PIN Incorrecto. No se pueden realizar cambios en la nube.");
        return false;
    }
}

function actualizarSelectorAnios() {
    const selector = document.getElementById('filtro-anio-arch');
    if (!selector) return;

    // 1. Obtenemos el a√±o actual
    const anioActual = new Date().getFullYear();
    
    // 2. Buscamos qu√© a√±os existen en las pacientes archivadas
    const aniosExistentes = archivadas.map(p => {
        return p.fecha_archivo ? p.fecha_archivo.split('-')[0] : null;
    }).filter(anio => anio !== null);

    // 3. Creamos una lista √∫nica de a√±os (incluyendo el actual por si acaso)
    const listaAnios = [...new Set([anioActual.toString(), ...aniosExistentes])];
    
    // 4. Los ordenamos de mayor a menor (el m√°s reciente arriba)
    listaAnios.sort((a, b) => b - a);

    // 5. Limpiamos y llenamos el selector
    selector.innerHTML = '<option value="todos">Todos los A√±os</option>';
    listaAnios.forEach(anio => {
        const option = document.createElement('option');
        option.value = anio;
        option.textContent = anio;
        selector.appendChild(option);
    });
}

function filtrarNombres(inputElement) {
    const textoBusqueda = inputElement.value.toLowerCase();
    // Detecta en qu√© secci√≥n estamos para filtrar la lista correcta
    const seccionActiva = document.querySelector('.section.active');
    const listaUl = seccionActiva.querySelector('ul');
    
    if (!listaUl) return;
    
    const items = listaUl.getElementsByTagName('li');

    for (let i = 0; i < items.length; i++) {
        const nombrePaciente = items[i].textContent.toLowerCase();
        // Si el nombre coincide con la b√∫squeda, se muestra; si no, se oculta
        if (nombrePaciente.indexOf(textoBusqueda) > -1) {
            items[i].style.display = ""; 
        } else {
            items[i].style.display = "none"; 
        }
    }
}


</script>
</body>
</html>